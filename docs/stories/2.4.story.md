# Story 2.4: Client Verification API Route

## Status
Draft

## Story
**As a** developer,
**I want** a Next.js API endpoint for client verification,
**so that** fingerprint data stays on the same domain.

## Acceptance Criteria
1. Create /api/verify-cloak POST endpoint
2. Accept verification token, fingerprint, and user ID in request
3. Forward data to TDS API for verification
4. Return valid/invalid/blacklisted status
5. Implement proper error handling and timeouts
6. Add rate limiting to prevent abuse
7. Include CORS headers for same-origin only
8. Log verification attempts for monitoring

## Tasks / Subtasks
- [ ] Create API route structure (AC: 1)
  - [ ] Create src/app/api/verify-cloak/route.ts
  - [ ] Add 'server-only' import at top of file
  - [ ] Export async POST function
  - [ ] Set up proper TypeScript types for route
  - [ ] Configure route for POST method only
- [ ] Define request/response types (AC: 2, 4)
  - [ ] Create VerifyRequest interface with token, fingerprint, userId
  - [ ] Add fingerprint components object to request type
  - [ ] Create VerifyResponse with action, reason, valid, blacklisted
  - [ ] Define action type as 'confirm' | 'revoke' | 'monitor'
  - [ ] Add timestamp to request validation
- [ ] Implement request parsing and validation (AC: 2)
  - [ ] Parse JSON body from request
  - [ ] Validate required fields (token, fingerprint, userId)
  - [ ] Use Zod schema for request validation
  - [ ] Return 400 Bad Request for invalid input
  - [ ] Include validation error details in response
- [ ] Integrate TDS API verification (AC: 3, 5)
  - [ ] Import trackerApiService from tracker.api.ts
  - [ ] Call verifyFingerprint method with request data
  - [ ] Handle TDS API response appropriately
  - [ ] Map TDS response to client response format
  - [ ] Implement timeout handling (inherit from base client)
  - [ ] Default to 'revoke' action on any error
- [ ] Add rate limiting middleware (AC: 6)
  - [ ] Create simple in-memory rate limiter for development
  - [ ] Limit to 10 requests per minute per IP
  - [ ] Extract client IP from headers (x-forwarded-for, x-real-ip)
  - [ ] Return 429 Too Many Requests when exceeded
  - [ ] Include Retry-After header in 429 response
  - [ ] Add TODO comment for Redis implementation in production
- [ ] Configure CORS headers (AC: 7)
  - [ ] Add Access-Control-Allow-Origin for same origin
  - [ ] Set Access-Control-Allow-Methods to POST
  - [ ] Add Access-Control-Allow-Headers for Content-Type
  - [ ] Ensure no wildcard origins allowed
  - [ ] Handle OPTIONS preflight requests
- [ ] Implement structured logging (AC: 8)
  - [ ] Import cloakLogger from logging module
  - [ ] Extract trace ID from request headers
  - [ ] Log verification attempts with cloakLogger.verification()
  - [ ] Include userId (hashed), result, and timing
  - [ ] Log rate limit violations separately
  - [ ] Never log sensitive fingerprint data
- [ ] Add error handling (AC: 5)
  - [ ] Wrap entire handler in try-catch
  - [ ] Return appropriate HTTP status codes
  - [ ] Log errors with trace ID correlation
  - [ ] Include user-friendly error messages
  - [ ] Ensure no internal details leak to client
- [ ] Create mock verification for development (AC: 3)
  - [ ] Add USE_MOCK_TDS check like in story 2.1
  - [ ] Return mock verification responses
  - [ ] Simulate various scenarios (valid, invalid, blacklisted)
  - [ ] Add artificial delay for realism
- [ ] Write API route tests (AC: 1-8)
  - [ ] Test successful verification flow
  - [ ] Test invalid request handling
  - [ ] Test rate limiting behavior
  - [ ] Test error scenarios
  - [ ] Verify logging output

## Dev Notes
### Previous Story Insights
- Story 2.1: Created TDS API client with verifyFingerprint method
- Story 2.2: Implemented CSS-based content control
- Story 2.3: Built client-side fingerprinting system
- This route bridges client fingerprinting with server-side TDS verification

### API Route Pattern
Based on [Source: architecture/api-integration.md]:
```typescript
// App Router API route
export async function POST(request: Request) {
  // Handler implementation
  return NextResponse.json(data, { status: 200 })
}
```

### Request/Response Format
Based on [Source: architecture/two-stage-cloaking-integration.md]:
```typescript
// Request
interface VerifyRequest {
  token: string           // From initial TDS decision
  fingerprint: string     // Hash from story 2.3
  components: object      // Raw fingerprint data
  userId: string          // Persistent user ID
  timestamp: number       // Client timestamp
}

// Response
interface VerifyResponse {
  action: 'confirm' | 'revoke' | 'monitor'
  reason: string
  valid?: boolean
  blacklisted?: boolean
}
```

### TDS API Integration
Based on [Source: architecture/api-integration.md#server-only-service-layer-pattern]:
- Use trackerApiService.verifyFingerprint() method
- Service already handles timeout and error cases
- Returns typed response with validation

### Rate Limiting Pattern
Simple in-memory implementation for development:
```typescript
const attempts = new Map<string, number[]>()
const WINDOW_MS = 60000 // 1 minute
const MAX_ATTEMPTS = 10
```

### CORS Configuration
Based on [Source: architecture/routing.md]:
- API routes handle their own CORS
- Same-origin only (no wildcards)
- Skip Next.js middleware for /api/ routes

### Logging Strategy
Based on [Source: architecture/observability-strategy.md#structured-logging]:
```typescript
cloakLogger.verification(traceId, {
  valid: result.valid,
  blacklisted: result.blacklisted,
  reason: result.reason,
  userId: hashUserId(userId), // Hash for privacy
  duration: performance.now() - startTime
})
```

### Error Handling
Based on [Source: architecture/development-standards.md#error-handling-standards]:
- Always fail safely (return 'revoke' action)
- Log errors with full context
- Return generic messages to client
- Use appropriate HTTP status codes

### File Locations
Based on [Source: architecture/source-tree.md]:
```
src/
└── app/
    └── api/
        └── verify-cloak/
            └── route.ts
```

### Testing
Based on [Source: architecture/testing-strategy.md]:
- Test with MSW for TDS API mocking
- Verify rate limiting logic
- Test CORS headers
- Check error scenarios

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-07 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record
### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_