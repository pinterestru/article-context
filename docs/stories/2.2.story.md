# Story 2.2: CSS-Based Content Control Implementation

## Status
Draft

## Story
**As a** compliance officer,
**I want** promotional content to be controlled via CSS classes only,
**so that** the HTML structure remains identical for all users.

## Acceptance Criteria
1. Create CSS module with .is-black-mode class definitions
2. Implement visibility rules that hide promotional elements by default
3. Add .is-black-mode class to body tag based on TDS decision
4. Ensure promotional content exists in DOM but is hidden via display:none
5. Create data-cloak="promotional" attribute for marking promotional sections
6. Verify no layout shift occurs when toggling visibility
7. Test CSS works without JavaScript enabled
8. Implement print styles that always show white mode

## Tasks / Subtasks
- [ ] Create cloaking CSS module (AC: 1, 2, 4)
  - [ ] Add cloaking styles to src/styles/globals.css
  - [ ] Define .cloak-hide class (hidden by default, shown in black mode)
  - [ ] Define .cloak-show class (shown by default, hidden in black mode)
  - [ ] Use display:none for hiding to prevent layout space reservation
  - [ ] Ensure specificity is appropriate for reliable overrides
  - [ ] Add CSS comments explaining the cloaking mechanism
- [ ] Implement print media styles (AC: 8)
  - [ ] Add @media print rules to force white mode
  - [ ] Hide all .cloak-hide elements in print
  - [ ] Show all .cloak-show elements in print
  - [ ] Override .is-black-mode styles for printing
  - [ ] Test print preview shows only white mode content
- [ ] Update root layout for body class (AC: 3)
  - [ ] Modify src/app/layout.tsx to accept cloaking props
  - [ ] Create server-side logic to apply .is-black-mode class
  - [ ] Ensure class is applied during SSR (no client-side flicker)
  - [ ] Pass TDS decision from page to layout
  - [ ] Handle cases where no decision exists (default to white)
- [ ] Create CloakingProvider component (AC: 3, 6)
  - [ ] Create src/providers/cloak-provider.tsx
  - [ ] Accept initial cloak mode from server
  - [ ] Apply .is-black-mode class to body element
  - [ ] Ensure no hydration mismatch warnings
  - [ ] Export context for child components to access mode
- [ ] Update article page integration (AC: 3, 5)
  - [ ] Pass TDS decision to CloakingProvider in layout
  - [ ] Add data-cloak="promotional" to promotional sections
  - [ ] Ensure all promotional content has proper attributes
  - [ ] Verify content exists in DOM regardless of mode
- [ ] Create promotional content components (AC: 5, 6)
  - [ ] Create example promotional sections with data-cloak
  - [ ] Use .cloak-hide class for black-mode-only content
  - [ ] Use .cloak-show class for white-mode-only content
  - [ ] Test both visibility states work correctly
  - [ ] Measure layout stability with Performance API
- [ ] Test CSS-only functionality (AC: 7)
  - [ ] Disable JavaScript in browser
  - [ ] Verify cloaking still works based on server-rendered class
  - [ ] Test with various browsers (Chrome, Firefox, Safari)
  - [ ] Ensure no FOUC (Flash of Unstyled Content)
- [ ] Add layout shift prevention (AC: 6)
  - [ ] Use CSS containment where appropriate
  - [ ] Reserve space for dynamic content if needed
  - [ ] Test with Chrome DevTools Layout Shift detector
  - [ ] Add will-change hints if beneficial
  - [ ] Document any performance optimizations
- [ ] Write CSS tests (AC: 1-8)
  - [ ] Test visibility toggling behavior
  - [ ] Verify print styles work correctly
  - [ ] Check for layout shift metrics
  - [ ] Test with and without JavaScript

## Dev Notes
### Previous Story Insights
- Story 2.1 established TDS API integration for server-side cloaking decisions
- TDS decision includes mode ('white' or 'black') passed from server
- Server Components can pass data to layout for SSR class application

### CSS Implementation Pattern
Based on [Source: architecture/styling-guidelines.md#critical-cloaking-styles]:
```css
/* Global cloaking styles */
.is-black-mode .cloak-hide {
  @apply hidden;
}

.cloak-show {
  @apply hidden;
}

.is-black-mode .cloak-show {
  @apply block;
}
```

### Data Attribute Convention
Based on [Source: architecture/epic-2-cloaking-implementation-verification.md]:
- Use `data-cloak="promotional"` for marking promotional sections
- Provides semantic markup for content control
- Allows CSS selectors like `[data-cloak="promotional"]`

### Server-Side Class Application
Based on [Source: architecture/two-stage-cloaking-integration.md]:
- Apply `.is-black-mode` class during SSR
- Initial state set in page/layout component
- No client-side JavaScript required for basic functionality

### Layout Stability Requirements
- Use `display: none` not `visibility: hidden`
- No layout space reserved when hidden
- Measure with Layout Shift API
- Target CLS (Cumulative Layout Shift) of 0

### Print Media Requirements
```css
@media print {
  .cloak-hide {
    display: none !important;
  }
  
  .cloak-show {
    display: block !important;
  }
  
  /* Force white mode for printing */
  body.is-black-mode .cloak-hide {
    display: none !important;
  }
}
```

### File Locations
Based on [Source: architecture/source-tree.md]:
```
src/
├── styles/
│   └── globals.css (update with cloaking styles)
├── providers/
│   └── cloak-provider.tsx (new)
├── app/
│   └── layout.tsx (update)
└── components/
    └── article/
        └── (update components with data-cloak)
```

### Testing Approach
Based on [Source: architecture/testing-strategy.md]:
- Visual regression tests for layout shifts
- Cross-browser testing for CSS compatibility
- Print preview testing
- JavaScript-disabled testing

### Performance Considerations
- CSS-only approach ensures fastest possible rendering
- No JavaScript execution needed for initial state
- Server-side rendering prevents flicker
- Print styles ensure compliance

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-07 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record
### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_