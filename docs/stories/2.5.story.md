# Story 2.5: Client-Side Verification Flow

## Status
Draft

## Story
**As a** user,
**I want** the page to load instantly,
**so that** I can access content without delays.

## Acceptance Criteria
1. Implement verification script that runs after page load
2. Only trigger verification if initial mode is black
3. Remove .is-black-mode class if verification fails
4. Add blacklisted users to local storage blocklist
5. Ensure verification doesn't block page interactivity
6. Show no visual changes during verification process
7. Complete entire verification within 300ms total
8. Handle network failures gracefully (maintain current state)

## Tasks / Subtasks
- [ ] Create client verification module (AC: 1, 2, 5)
  - [ ] Create src/lib/cloak/verification.ts
  - [ ] Implement ClientVerification class
  - [ ] Add init() method that checks initial mode
  - [ ] Use requestIdleCallback or setTimeout for non-blocking execution
  - [ ] Add 100ms natural delay before starting verification
  - [ ] Only proceed if mode === 'black' and verifyToken exists
- [ ] Implement verification flow (AC: 1, 3, 7)
  - [ ] Collect fingerprint using module from story 2.3
  - [ ] Call /api/verify-cloak endpoint from story 2.4
  - [ ] Handle verification response (confirm/revoke/monitor)
  - [ ] Remove .is-black-mode class on 'revoke' action
  - [ ] Measure total time with Performance API
  - [ ] Ensure completion within 300ms budget
- [ ] Add blacklist management (AC: 4)
  - [ ] Create blacklist storage utility
  - [ ] Use localStorage key 'cloak-blacklist'
  - [ ] Store userId and timestamp when blacklisted
  - [ ] Check blacklist before verification attempt
  - [ ] Prevent verification for blacklisted users
  - [ ] Handle localStorage errors gracefully
- [ ] Create verification hook (AC: 1, 2, 6)
  - [ ] Create src/hooks/use-verification.ts
  - [ ] Initialize verification on component mount
  - [ ] Pass initial cloak state from server
  - [ ] Ensure no visual flicker during verification
  - [ ] Use useEffect with proper dependencies
  - [ ] Clean up on unmount
- [ ] Handle network failures (AC: 8)
  - [ ] Add try-catch around API calls
  - [ ] Maintain current state on network errors
  - [ ] Don't remove .is-black-mode on timeout
  - [ ] Log failures for monitoring
  - [ ] Implement exponential backoff for retries
  - [ ] Set maximum retry attempts (e.g., 2)
- [ ] Integrate with CloakProvider (AC: 3, 6)
  - [ ] Update CloakProvider from story 2.2
  - [ ] Add verification state management
  - [ ] Expose methods to update body class
  - [ ] Ensure atomic class updates (no flicker)
  - [ ] Coordinate with server-side rendering
- [ ] Add performance monitoring (AC: 7)
  - [ ] Track fingerprint collection time
  - [ ] Track API call duration
  - [ ] Track total verification time
  - [ ] Log performance metrics
  - [ ] Alert if exceeding 300ms budget
  - [ ] Include trace ID for correlation
- [ ] Update article page integration (AC: 1, 2)
  - [ ] Pass verifyToken from TDS decision to client
  - [ ] Initialize verification in article layout
  - [ ] Ensure verification runs once per page load
  - [ ] Handle cases with no token (white mode)
- [ ] Write tests (AC: 1-8)
  - [ ] Test verification trigger conditions
  - [ ] Test blacklist functionality
  - [ ] Test network failure handling
  - [ ] Test performance requirements
  - [ ] Test visual stability

## Dev Notes
### Previous Story Insights
- Story 2.1: TDS provides initial decision with verifyToken
- Story 2.2: CSS class controls visibility (.is-black-mode)
- Story 2.3: Fingerprint collection in 150ms
- Story 2.4: Verification API endpoint created
- This story ties everything together client-side

### Verification Flow Architecture
Based on [Source: architecture/two-stage-cloaking-integration.md]:
```typescript
class ClientVerification {
  async init() {
    if (this.config.mode === 'white') return;
    
    // Natural delay for authenticity
    await this.delay(100);
    
    // Collect and verify
    const fpData = await this.fingerprint.collect();
    const result = await this.verify(fpData);
    
    // Handle result
    if (result.action === 'revoke') {
      this.removeBlackMode();
    }
  }
}
```

### Performance Budget
Based on [Source: architecture/two-stage-cloaking-integration.md]:
- Total budget: 300ms
- Fingerprint collection: 150ms (from story 2.3)
- API call + processing: 150ms
- Natural delay: 100ms (overlaps with page render)

### Blacklist Storage Pattern
Based on [Source: architecture/state-management.md#cloak-storage]:
```typescript
interface BlacklistEntry {
  userId: string
  timestamp: number
  fingerprint?: string
}

// Storage key: 'cloak-blacklist'
```

### Network Failure Handling
Based on [Source: architecture/api-integration.md]:
- Maintain current state on failure
- Never remove .is-black-mode on error
- Log failures with trace ID
- Fail safely (keep current mode)

### Non-Blocking Execution
```typescript
// Use requestIdleCallback with fallback
const scheduleVerification = (callback: () => void) => {
  if ('requestIdleCallback' in window) {
    requestIdleCallback(callback, { timeout: 300 });
  } else {
    setTimeout(callback, 0);
  }
};
```

### Visual Stability Requirements
Based on [Source: architecture/styling-guidelines.md]:
- No layout shift (CLS = 0)
- No visual flicker
- Atomic class updates only
- CSS handles all visibility

### Observability Integration
Based on [Source: architecture/observability-strategy.md]:
```typescript
// Log verification events
logger.info('cloak_verification_start', {
  traceId,
  mode: initialMode,
  hasToken: !!verifyToken
});

// Track performance
if (duration > 200) {
  logger.warn('cloak_verification_slow', {
    traceId,
    duration,
    breakdown: { fingerprint: fpTime, api: apiTime }
  });
}
```

### File Locations
Based on [Source: architecture/source-tree.md]:
```
src/
├── lib/
│   └── cloak/
│       └── verification.ts
├── hooks/
│   └── use-verification.ts
└── providers/
    └── cloak-provider.tsx (update)
```

### Testing Approach
Based on [Source: architecture/testing-strategy.md]:
- Mock requestIdleCallback for tests
- Test with various network conditions
- Verify no visual changes occur
- Performance benchmarks

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-07 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record
### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_