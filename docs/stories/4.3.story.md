# Story 4.3: Yandex Metrica Integration

## Status
Draft

## Story
**As a** regional marketing manager,
**I want** Yandex Metrica installed,
**so that** we can optimize for Russian market traffic.

## Acceptance Criteria
1. Add Yandex Metrica tag via GTM
2. Configure goal tracking for Russian user conversions
3. Set up heatmap tracking for mobile interactions
4. Implement webvisor session recording (white mode only)
5. Track Yandex-specific UTM parameters
6. Configure counter settings for accurate bounce rate
7. Set up e-commerce tracking for affiliate conversions
8. Test Yandex.Direct auto-goals integration

## Tasks / Subtasks
- [ ] Configure Yandex Metrica tag in GTM (AC: 1)
  - [ ] Create Yandex Metrica counter in Yandex dashboard
  - [ ] Add Custom HTML tag in GTM for Yandex Metrica
  - [ ] Configure counter ID from environment variable
  - [ ] Set up tag firing trigger for All Pages
  - [ ] Enable e-commerce data layer integration
  - [ ] Test tag loads correctly in Preview mode
- [ ] Create Yandex Metrica utilities (AC: 1, 4, 5)
  - [ ] Create src/lib/analytics/yandex-metrica.ts
  - [ ] Define TypeScript types for Yandex events
  - [ ] Create webvisor control functions
  - [ ] Implement yclid parameter tracking
  - [ ] Add Russian text sanitization utilities
  - [ ] Test utilities handle edge cases
- [ ] Implement webvisor control based on cloak mode (AC: 4)
  - [ ] Create dynamic webvisor state management
  - [ ] Disable webvisor when is-black-mode class present
  - [ ] Enable webvisor only for white mode users
  - [ ] Update webvisor state on mode changes
  - [ ] Test webvisor respects privacy settings
  - [ ] Verify no recording in black mode
- [ ] Set up goal tracking for conversions (AC: 2)
  - [ ] Define goals in Yandex Metrica dashboard
  - [ ] Create goal completion events in GTM
  - [ ] Map promocode copy to Goal 1
  - [ ] Map promocode click to Goal 2
  - [ ] Map article completion to Goal 3
  - [ ] Test goals fire correctly
- [ ] Configure mobile heatmap tracking (AC: 3)
  - [ ] Enable clickmap in Yandex Metrica settings
  - [ ] Add mobile interaction tracking events
  - [ ] Track tap, swipe, and scroll gestures
  - [ ] Configure heatmap data collection
  - [ ] Test on various mobile devices
  - [ ] Verify heatmap data appears in dashboard
- [ ] Track Yandex-specific parameters (AC: 5)
  - [ ] Extract yclid from URL parameters
  - [ ] Store yclid in session for attribution
  - [ ] Send yclid with conversion events
  - [ ] Track Yandex.Direct campaign data
  - [ ] Handle utm_source=yandex parameters
  - [ ] Test parameter persistence across pages
- [ ] Configure accurate bounce rate (AC: 6)
  - [ ] Set accurateTrackBounce to true
  - [ ] Configure 15-second engagement threshold
  - [ ] Track scroll depth for engagement
  - [ ] Implement non-bounce event triggers
  - [ ] Test bounce rate calculation
  - [ ] Verify metrics match expectations
- [ ] Implement e-commerce tracking (AC: 7)
  - [ ] Configure e-commerce container in GTM
  - [ ] Map affiliate clicks to product views
  - [ ] Track promocode as product interactions
  - [ ] Send purchase events for conversions
  - [ ] Include merchant and category data
  - [ ] Test e-commerce data flow
- [ ] Set up Yandex.Direct integration (AC: 8)
  - [ ] Configure auto-goals in Yandex.Direct
  - [ ] Link Metrica counter to Direct account
  - [ ] Map conversion events to Direct goals
  - [ ] Test goal data flows to Direct
  - [ ] Verify cost data import works
  - [ ] Document goal ID mappings
- [ ] Integrate with existing analytics (AC: 1-8)
  - [ ] Update unified analytics wrapper
  - [ ] Ensure events fire to all platforms
  - [ ] Maintain trace ID consistency
  - [ ] Add Yandex events to debug dashboard
  - [ ] Test parallel tracking works
  - [ ] Document Yandex-specific events
- [ ] Write comprehensive tests (AC: 1-8)
  - [ ] Unit test Yandex Metrica utilities
  - [ ] Test webvisor state management
  - [ ] Mock Yandex Metrica API calls
  - [ ] Test yclid parameter extraction
  - [ ] Test e-commerce event structure
  - [ ] E2E test Russian user journey

## Dev Notes
### Previous Story Insights
- Story 4.1 established GTM foundation with dataLayer
- Story 4.2 implemented GA4 with custom dimensions and e-commerce tracking
- GTM container configured to handle multiple analytics platforms
- Cloak mode detection already available via body class
- Trace ID system established for cross-platform correlation

### Yandex Metrica GTM Configuration
Based on [Source: architecture/observability-strategy.md]:
```javascript
// GTM Custom HTML Tag - Yandex Metrica
<script type="text/javascript">
   (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
   m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   ym({{YM_COUNTER_ID}}, "init", {
        clickmap: true,
        trackLinks: true,
        accurateTrackBounce: 15000,
        webvisor: {{YM_WEBVISOR_ENABLED}},
        ecommerce: "dataLayer"
   });
</script>

// GTM Variables:
// {{YM_COUNTER_ID}}: Constant - from NEXT_PUBLIC_YANDEX_METRICA_ID
// {{YM_WEBVISOR_ENABLED}}: Custom JavaScript Variable
function() {
  return !document.body.classList.contains('is-black-mode');
}
```

### Yandex Metrica Event Types
Based on [Source: architecture/observability-strategy.md#posthog-analytics-integration]:
```typescript
// src/lib/analytics/yandex-metrica.ts
declare global {
  interface Window {
    ym: (counterId: string | number, action: string, ...params: any[]) => void;
  }
}

export const yandexMetricaEvents = {
  // Goal completion events
  goalComplete: (goalId: string, params?: Record<string, any>) => {
    const counterId = process.env.NEXT_PUBLIC_YANDEX_METRICA_ID;
    if (window.ym && counterId) {
      window.ym(counterId, 'reachGoal', goalId, params);
    }
  },

  // E-commerce tracking
  ecommerce: (action: 'detail' | 'add' | 'purchase', data: any) => {
    window.dataLayer?.push({
      event: 'ym-ecommerce',
      ecommerce: {
        [action]: data
      }
    });
  },

  // Custom parameters
  params: (parameters: Record<string, any>) => {
    const counterId = process.env.NEXT_PUBLIC_YANDEX_METRICA_ID;
    if (window.ym && counterId) {
      window.ym(counterId, 'params', parameters);
    }
  }
};
```

### Webvisor Control Implementation
Based on cloak mode requirements:
```typescript
// src/lib/analytics/webvisor-control.ts
export class WebvisorController {
  private static instance: WebvisorController;
  private observer: MutationObserver | null = null;
  
  static getInstance(): WebvisorController {
    if (!WebvisorController.instance) {
      WebvisorController.instance = new WebvisorController();
    }
    return WebvisorController.instance;
  }

  initialize() {
    if (typeof window === 'undefined') return;
    
    // Initial state
    this.updateWebvisorState();
    
    // Watch for cloak mode changes
    this.observer = new MutationObserver(() => {
      this.updateWebvisorState();
    });
    
    this.observer.observe(document.body, {
      attributes: true,
      attributeFilter: ['class']
    });
  }

  private updateWebvisorState() {
    const counterId = process.env.NEXT_PUBLIC_YANDEX_METRICA_ID;
    if (!window.ym || !counterId) return;
    
    const isBlackMode = document.body.classList.contains('is-black-mode');
    
    // Disable webvisor in black mode
    window.ym(counterId, 'params', {
      webvisor: !isBlackMode,
      // Also disable other recording features
      clickmap: !isBlackMode,
      trackLinks: true // Keep link tracking in all modes
    });
    
    // Log for debugging
    console.log(`[Yandex Metrica] Webvisor ${!isBlackMode ? 'enabled' : 'disabled'}`);
  }
}
```

### Yandex-Specific Parameter Tracking
Based on Russian market requirements:
```typescript
// src/lib/analytics/yandex-tracking.ts
export const yandexTracking = {
  // Track Yandex.Direct click ID
  trackYclid: (yclid: string, articleSlug: string) => {
    if (!yclid) return;
    
    // Store for attribution
    sessionStorage.setItem('_yclid', yclid);
    sessionStorage.setItem('_yclid_time', Date.now().toString());
    sessionStorage.setItem('_yclid_page', articleSlug);
    
    // Send to Yandex Metrica
    yandexMetricaEvents.params({
      yclid,
      source: 'yandex_direct',
      article: articleSlug,
      trace_id: window.__TRACE_ID__
    });
  },

  // Get stored yclid for conversion attribution
  getStoredYclid: () => {
    const yclid = sessionStorage.getItem('_yclid');
    const time = sessionStorage.getItem('_yclid_time');
    
    // Check if yclid is still valid (24 hour window)
    if (yclid && time) {
      const elapsed = Date.now() - parseInt(time);
      if (elapsed < 24 * 60 * 60 * 1000) {
        return yclid;
      }
    }
    return null;
  }
};
```

### E-commerce Implementation for Affiliates
Based on [Source: architecture/observability-strategy.md]:
```typescript
// Map affiliate interactions to e-commerce events
export const yandexEcommerce = {
  // When user views promocode
  viewProduct: (promocode: {
    code: string;
    merchant: string;
    discount: string;
    position: string;
  }) => {
    yandexMetricaEvents.ecommerce('detail', {
      products: [{
        id: promocode.code,
        name: `${promocode.merchant} - ${promocode.discount}`,
        category: 'promocode',
        brand: promocode.merchant,
        position: promocode.position
      }]
    });
  },

  // When user clicks promocode
  addToCart: (promocode: {
    code: string;
    merchant: string;
    targetUrl: string;
  }) => {
    yandexMetricaEvents.ecommerce('add', {
      products: [{
        id: promocode.code,
        name: promocode.merchant,
        category: 'promocode',
        quantity: 1
      }]
    });
  },

  // Track conversion (redirect to merchant)
  purchase: (promocode: {
    code: string;
    merchant: string;
  }) => {
    const yclid = yandexTracking.getStoredYclid();
    
    yandexMetricaEvents.ecommerce('purchase', {
      id: `${Date.now()}-${promocode.code}`,
      affiliation: promocode.merchant,
      revenue: 1, // Affiliate tracking metric
      products: [{
        id: promocode.code,
        name: promocode.merchant,
        category: 'promocode',
        quantity: 1
      }],
      // Include yclid for Yandex.Direct ROI
      ...(yclid && { yclid })
    });
  }
};
```

### Mobile Heatmap Tracking
```typescript
// src/lib/analytics/mobile-heatmap.ts
export const mobileHeatmap = {
  trackInteraction: (event: TouchEvent | MouseEvent, element: HTMLElement) => {
    const rect = element.getBoundingClientRect();
    const x = 'touches' in event ? 
      event.touches[0].clientX - rect.left : 
      (event as MouseEvent).clientX - rect.left;
    const y = 'touches' in event ? 
      event.touches[0].clientY - rect.top : 
      (event as MouseEvent).clientY - rect.top;
    
    yandexMetricaEvents.params({
      interaction: {
        element: element.dataset.trackingName || element.tagName,
        action: event.type,
        x: Math.round(x),
        y: Math.round(y),
        viewport: {
          width: window.innerWidth,
          height: window.innerHeight
        }
      }
    });
  }
};
```

### Goal Configuration
```typescript
// Goal IDs to be configured in Yandex Metrica dashboard
export const YANDEX_GOALS = {
  PROMOCODE_VIEWED: 'promocode_viewed',
  PROMOCODE_COPIED: 'promocode_copied', 
  PROMOCODE_CLICKED: 'promocode_clicked',
  ARTICLE_READ: 'article_read',
  SCROLL_75: 'scroll_75',
  ENGAGED_USER: 'engaged_15s'
} as const;
```

### Integration with Existing Analytics
Based on [Source: architecture/observability-strategy.md#posthog-analytics-integration]:
```typescript
// Update analytics wrapper to include Yandex
export const analytics = {
  promocodeInteraction: (data: PromocodeInteractionData) => {
    // Existing PostHog tracking
    posthog?.capture('promocode_interaction', data);
    
    // GA4 tracking (from story 4.2)
    ga4Events.promocodeInteraction(data);
    
    // Yandex Metrica tracking
    if (data.action === 'viewed') {
      yandexEcommerce.viewProduct({
        code: data.code,
        merchant: data.merchant || 'unknown',
        discount: data.discount || '',
        position: data.position
      });
    } else if (data.action === 'copied') {
      yandexMetricaEvents.goalComplete(YANDEX_GOALS.PROMOCODE_COPIED, {
        code: data.code,
        trace_id: data.traceId
      });
    } else if (data.action === 'clicked') {
      yandexEcommerce.addToCart({
        code: data.code,
        merchant: data.merchant || 'unknown',
        targetUrl: data.targetUrl
      });
      yandexMetricaEvents.goalComplete(YANDEX_GOALS.PROMOCODE_CLICKED);
    }
  }
};
```

### Environment Variables
Based on [Source: architecture/environment-configuration.md]:
```env
# Yandex Metrica
NEXT_PUBLIC_YANDEX_METRICA_ID=12345678
```

### Content Security Policy Updates
Add to existing CSP:
```typescript
script-src 'self' 'unsafe-inline' https://mc.yandex.ru https://yastatic.net;
connect-src 'self' https://mc.yandex.ru https://mc.yandex.com;
img-src 'self' https://mc.yandex.ru;
```

### File Locations
Based on [Source: architecture/source-tree.md]:
```
src/
├── lib/
│   └── analytics/
│       ├── yandex-metrica.ts
│       ├── webvisor-control.ts
│       ├── yandex-tracking.ts
│       ├── mobile-heatmap.ts
│       └── yandex-ecommerce.ts
```

### Testing
#### Test File Locations
- Yandex utilities: `src/lib/analytics/__tests__/yandex-metrica.test.ts`
- Webvisor control: `src/lib/analytics/__tests__/webvisor-control.test.ts`
- E2E tests: `e2e/yandex-tracking.spec.ts`

#### Testing Standards
Based on [Source: architecture/testing-strategy.md]:
- Mock window.ym function
- Test webvisor state changes with cloak mode
- Verify yclid parameter extraction and storage
- Test goal completion events
- E2E test Russian user journey with Yandex.Direct

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-07 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record
### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_