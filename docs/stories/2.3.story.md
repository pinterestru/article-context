# Story 2.3: Client-Side Fingerprinting System

## Status
Draft

## Story
**As a** security analyst,
**I want** to collect browser fingerprints safely,
**so that** we can verify users without triggering privacy concerns.

## Acceptance Criteria
1. Create fingerprint collection module using only safe parameters
2. Implement screen resolution, viewport, timezone, language detection
3. Generate persistent user ID and store in localStorage
4. Create fingerprint hash function for consistency
5. Ensure fingerprinting works across all major browsers
6. Handle missing APIs gracefully with fallback values
7. Complete fingerprint collection within 150ms
8. Match fingerprint parameters with mainstream analytics tools

## Tasks / Subtasks
- [ ] Create fingerprint collection module (AC: 1, 2, 6)
  - [ ] Create src/lib/cloak/fingerprint.ts
  - [ ] Implement screen dimension collection (width, height, availWidth, availHeight)
  - [ ] Collect viewport dimensions (innerWidth, innerHeight)
  - [ ] Get timezone offset and IANA timezone string
  - [ ] Collect language settings (navigator.language, languages array)
  - [ ] Add feature detection for each API before access
  - [ ] Provide fallback values for missing APIs
- [ ] Add browser and system information (AC: 1, 8)
  - [ ] Collect user agent string
  - [ ] Get platform information
  - [ ] Check cookie enabled status
  - [ ] Detect Do Not Track preference
  - [ ] Get hardware concurrency (CPU cores)
  - [ ] Check device memory (Chrome/Edge only with fallback)
  - [ ] Detect touch support (maxTouchPoints)
- [ ] Implement storage and capability detection (AC: 1, 6)
  - [ ] Check localStorage/sessionStorage availability
  - [ ] Detect IndexedDB support
  - [ ] Check Service Worker support
  - [ ] Basic WebGL support check (no detailed specs)
  - [ ] Media devices presence check
  - [ ] Geolocation API availability
- [ ] Create user ID generation system (AC: 3)
  - [ ] Generate UUID using crypto.randomUUID()
  - [ ] Create getUserId() function with localStorage check
  - [ ] Store user ID persistently in localStorage
  - [ ] Handle localStorage errors gracefully
  - [ ] Return consistent ID across sessions
- [ ] Implement fingerprint hash function (AC: 4)
  - [ ] Create generateHash() using Web Crypto API
  - [ ] Use SHA-256 for consistency
  - [ ] Sort object keys before hashing for consistency
  - [ ] Return hex string representation
  - [ ] Handle async nature of crypto.subtle.digest
- [ ] Build main fingerprint collection function (AC: 7)
  - [ ] Create collectFingerprint() as main entry point
  - [ ] Implement performance timing with Performance API
  - [ ] Pre-compute static values for efficiency
  - [ ] Structure return object with all parameters
  - [ ] Ensure collection completes within 150ms
  - [ ] Add performance logging
- [ ] Add browser compatibility layer (AC: 5, 6)
  - [ ] Test in Chrome, Firefox, Safari, Edge
  - [ ] Handle Safari's privacy restrictions
  - [ ] Account for Firefox's resistFingerprinting mode
  - [ ] Ensure mobile browser compatibility
  - [ ] Document browser-specific limitations
- [ ] Create fingerprint types (AC: 1)
  - [ ] Create src/types/fingerprint.ts
  - [ ] Define FingerprintData interface
  - [ ] Define FingerprintResult with hash and userId
  - [ ] Add proper TypeScript types for all parameters
  - [ ] Export types for use in other modules
- [ ] Write unit tests (AC: 1-8)
  - [ ] Test parameter collection accuracy
  - [ ] Verify fallback behavior
  - [ ] Test performance requirements (150ms)
  - [ ] Mock browser APIs for testing
  - [ ] Test cross-browser compatibility

## Dev Notes
### Previous Story Insights
- Story 2.1: TDS API integration for server-side decisions
- Story 2.2: CSS-based content control implementation
- Fingerprinting will be used for client-side verification after initial TDS decision

### Safe Fingerprinting Parameters
Based on [Source: architecture/fingerprint.md#safe-parameters]:
**Collect these parameters:**
- Display: screen dimensions, color depth, pixel ratio, viewport
- Browser: user agent, language, platform, vendor, cookies enabled
- Timezone: offset, IANA string, locale
- Hardware: CPU cores, device memory (with fallback), touch support
- Capabilities: storage APIs, Service Worker, basic WebGL check

**DO NOT collect (privacy concerns):**
- Canvas fingerprinting
- WebGL details
- Font enumeration
- Plugin lists
- WebRTC local IPs
- Battery API

### Hash Generation Implementation
Based on [Source: architecture/fingerprint.md#hash-generation]:
```typescript
async function generateHash(data: object): Promise<string> {
  const json = JSON.stringify(data, Object.keys(data).sort());
  const msgBuffer = new TextEncoder().encode(json);
  const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}
```

### Performance Requirements
Based on [Source: architecture/two-stage-cloaking-integration.md]:
- Fingerprint collection: 150ms max
- Total verification: 300ms max (includes API call)
- Pre-compute static values for efficiency
- Lightweight collection approach (<10ms for static values)

### User ID Storage
Based on [Source: architecture/fingerprint.md#user-id-generation]:
```typescript
function getUserId(): string {
  const stored = localStorage.getItem('uid');
  if (stored) return stored;
  
  const newId = crypto.randomUUID();
  localStorage.setItem('uid', newId);
  return newId;
}
```

### Browser Compatibility
Based on [Source: architecture/fingerprint.md#browser-compatibility]:
- Feature detection before API access
- Graceful fallbacks for missing APIs
- Chrome/Edge specific: deviceMemory
- Safari: may restrict some APIs
- Firefox: resistFingerprinting mode

### Analytics Compatibility
Based on [Source: architecture/fingerprint.md#analytics-compatibility]:
- Match parameters with Yandex Metrica
- Compatible with Google Analytics
- Makes fingerprinting indistinguishable from normal analytics

### File Locations
Based on [Source: architecture/source-tree.md]:
```
src/
├── lib/
│   └── cloak/
│       └── fingerprint.ts
└── types/
    └── fingerprint.ts
```

### Testing Approach
Based on [Source: architecture/testing-strategy.md]:
- Mock browser APIs for consistent testing
- Performance benchmarks with vitest
- Cross-browser testing matrix
- Fallback scenario coverage

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-07 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record
### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_