# Story 3.4: Promocode API Integration

## Status
Draft

## Story
**As a** product owner,
**I want** promocodes to be dynamically loaded,
**so that** we can update offers without code changes.

## Acceptance Criteria
1. Create API service for fetching promocodes by partner/article
2. Implement #promocode_list widget that fetches from API
3. Cache promocode data appropriately (5 minute TTL)
4. Handle API failures gracefully with fallback content
5. Support A/B testing different promocode offers
6. Include offer metadata (discount %, expiration, terms)
7. Implement loading skeleton while fetching
8. Pass click IDs to API for personalized offers

## Tasks / Subtasks
- [ ] Create promocode API service (AC: 1, 6)
  - [ ] Create src/lib/services/promocode/promocode.types.ts
  - [ ] Define Zod schemas for API responses
  - [ ] Create TypeScript types from schemas
  - [ ] Include metadata fields (discount, expiration, terms)
  - [ ] Add variant field for A/B testing
  - [ ] Create comprehensive validation rules
- [ ] Implement server-only API client (AC: 1, 8)
  - [ ] Create src/lib/services/promocode/promocode.api.ts
  - [ ] Add 'server-only' import directive
  - [ ] Implement fetchPromocodes function
  - [ ] Accept partner, article, clickId parameters
  - [ ] Use base HTTP client with schema validation
  - [ ] Add proper error handling with APIError
- [ ] Configure caching strategy (AC: 3)
  - [ ] Set 5-minute TTL with next.revalidate: 300
  - [ ] Wrap service in React.cache() for deduplication
  - [ ] Add cache tags for invalidation
  - [ ] Include variant in cache key for A/B testing
  - [ ] Document cache warming strategy
  - [ ] Test cache behavior in development
- [ ] Create PromocodeListWidget (AC: 2, 7)
  - [ ] Create src/components/widgets/PromocodeListWidget.tsx
  - [ ] Register widget for #promocode_list action
  - [ ] Parse widget config for partner/article params
  - [ ] Implement server component for data fetching
  - [ ] Add loading skeleton component
  - [ ] Render multiple PromoCodeWidget instances
- [ ] Implement loading states (AC: 7)
  - [ ] Create PromocodeListSkeleton component
  - [ ] Use Tailwind animate-pulse for skeleton
  - [ ] Match skeleton to actual content layout
  - [ ] Show appropriate number of skeleton items
  - [ ] Ensure smooth transition to loaded state
  - [ ] Test loading state appearance
- [ ] Handle API failures gracefully (AC: 4)
  - [ ] Create fallback promocode data structure
  - [ ] Implement try-catch in data fetching
  - [ ] Log errors with proper context
  - [ ] Show fallback content on error
  - [ ] Add error boundary around widget
  - [ ] Monitor error rates in production
- [ ] Support A/B testing (AC: 5)
  - [ ] Pass variant parameter to API
  - [ ] Include variant in cache keys
  - [ ] Support variant selection logic
  - [ ] Track variant performance
  - [ ] Document variant configuration
  - [ ] Test multiple variants
- [ ] Pass click tracking data (AC: 8)
  - [ ] Extract clickId from URL parameters
  - [ ] Pass clickId to promocode API
  - [ ] Support personalized offers based on clickId
  - [ ] Handle missing clickId gracefully
  - [ ] Document clickId flow
  - [ ] Test personalization logic
- [ ] Write comprehensive tests (AC: 1-8)
  - [ ] Unit test API service with MSW
  - [ ] Test Zod schema validation
  - [ ] Test cache behavior
  - [ ] Test error scenarios
  - [ ] Test loading states
  - [ ] E2E test widget integration

## Dev Notes
### Previous Story Insights
- Story 3.1 created widget framework with registry
- Story 3.2 created PromoCodeWidget component
- Story 3.3 added copy functionality
- Widgets hydrate based on data-action attributes

### Promocode API Schema
Based on [Source: architecture/type-safety-validation.md#comprehensive-api-response-validation]:
```typescript
// src/lib/services/promocode/promocode.types.ts
import { z } from 'zod';

export const PromocodeSchema = z.object({
  id: z.string(),
  code: z.string().regex(/^[A-Z0-9]{4,20}$/),
  discount: z.string(), // e.g., "20%", "$10"
  description: z.string().optional(),
  expiresAt: z.string().datetime().optional(),
  terms: z.array(z.string()).optional(),
  variant: z.string().optional(), // A/B test variant
  priority: z.number().optional()
});

export const PromocodesResponseSchema = z.object({
  promocodes: z.array(PromocodeSchema),
  metadata: z.object({
    partner: z.string(),
    article: z.string(),
    variant: z.string().optional(),
    ttl: z.number().default(300)
  })
});

export type Promocode = z.infer<typeof PromocodeSchema>;
export type PromocodesResponse = z.infer<typeof PromocodesResponseSchema>;
```

### Server-Only Service Pattern
Based on [Source: architecture/api-integration.md#server-only-service-layer-pattern]:
```typescript
// src/lib/services/promocode/promocode.api.ts
import 'server-only';
import { cache } from 'react';
import { httpClient } from '@/lib/http/client';
import { PromocodesResponseSchema } from './promocode.types';

export const fetchPromocodes = cache(async (params: {
  partner: string;
  article: string;
  clickId?: string;
  variant?: string;
}) => {
  const searchParams = new URLSearchParams({
    partner: params.partner,
    article: params.article,
    ...(params.clickId && { click_id: params.clickId }),
    ...(params.variant && { variant: params.variant })
  });

  return httpClient.get(
    `/api/promocodes?${searchParams}`,
    PromocodesResponseSchema,
    {
      next: { 
        revalidate: 300, // 5 minute TTL
        tags: [`promocode:${params.partner}:${params.article}`]
      }
    }
  );
});
```

### PromocodeListWidget Implementation
Based on [Source: architecture/component-standards.md]:
```typescript
// Server component for data fetching
export async function PromocodeListWidget({ 
  partner, 
  article,
  variant 
}: PromocodeListConfig) {
  const clickId = headers().get('x-click-id');
  
  try {
    const { promocodes } = await fetchPromocodes({
      partner,
      article,
      clickId,
      variant
    });
    
    return (
      <div className="space-y-4">
        {promocodes.map((promo) => (
          <PromoCodeWidget
            key={promo.id}
            code={promo.code}
            discount={promo.discount}
            description={promo.description}
            expiresAt={promo.expiresAt}
            variant="card"
          />
        ))}
      </div>
    );
  } catch (error) {
    // Fallback content
    return <PromocodeListFallback />;
  }
}
```

### Loading Skeleton Pattern
Based on [Source: architecture/component-standards.md]:
```typescript
export function PromocodeListSkeleton() {
  return (
    <div className="space-y-4">
      {[1, 2, 3].map((i) => (
        <div key={i} className="animate-pulse">
          <div className="h-24 bg-gray-200 rounded-lg" />
        </div>
      ))}
    </div>
  );
}
```

### Caching Strategy
Based on [Source: architecture/caching-strategy.md#caching-rules-for-different-content-types]:
- 5-minute TTL for promocodes (dynamic content)
- Use cache tags for granular invalidation
- Include variant in cache key for A/B testing
- Monitor cache hit rates

### Error Handling
Based on [Source: architecture/type-safety-validation.md#service-layer-with-validation]:
```typescript
try {
  const data = await fetchPromocodes(params);
  return data;
} catch (error) {
  if (error instanceof ValidationError) {
    logger.error('Invalid promocode data', error);
  }
  // Return fallback data
  return { promocodes: fallbackPromocodes };
}
```

### Widget Registration
Based on story 3.1 widget registry pattern:
```typescript
// Register in widget registry
widgetRegistry.register('promocode_list', PromocodeListWidget);
```

### File Locations
Based on [Source: architecture/source-tree.md]:
```
src/
├── lib/
│   └── services/
│       └── promocode/
│           ├── promocode.api.ts
│           └── promocode.types.ts
├── components/
│   └── widgets/
│       ├── PromocodeListWidget.tsx
│       └── PromocodeListSkeleton.tsx
```

### Testing
#### Test File Locations
- Service tests: `src/lib/services/promocode/__tests__/`
- Component tests: `src/components/widgets/__tests__/`
- E2E tests: `e2e/promocode-api.spec.ts`

#### Testing Standards
Based on [Source: architecture/testing-strategy.md]:
- Mock API responses with MSW
- Test schema validation edge cases
- Verify cache behavior
- Test error scenarios
- Check loading states

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-07 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record
### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_