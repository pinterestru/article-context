# Story 2.6: Investigation Behavior Detection

## Status
Draft

## Story
**As a** security analyst,
**I want** to detect suspicious investigation patterns,
**so that** we can revoke access dynamically.

## Acceptance Criteria
1. Monitor for developer tools opening (with multiple detection methods)
2. Track rapid multiple clicks on promotional elements
3. Detect right-click attempts on promotional content
4. Monitor extended hovering over links (>3 seconds)
5. Immediately remove .is-black-mode class when detected
6. Add detected users to permanent blacklist
7. Send investigation event to TDS API
8. Test detection works across different browsers

## Tasks / Subtasks
- [ ] Create investigation detection module (AC: 1-4)
  - [ ] Create src/lib/cloak/detector.ts
  - [ ] Implement InvestigationDetector class
  - [ ] Add event tracking array with timestamps
  - [ ] Create suspicion score system
  - [ ] Initialize detection on page load
  - [ ] Ensure non-blocking execution
- [ ] Implement DevTools detection (AC: 1, 8)
  - [ ] Add window size comparison method (outerHeight/Width vs innerHeight/Width)
  - [ ] Implement console timing detection
  - [ ] Add debugger statement detection
  - [ ] Create Chrome-specific detection (chrome.runtime check)
  - [ ] Add Firefox-specific detection (firebug)
  - [ ] Run detection every 500ms
  - [ ] Test across Chrome, Firefox, Safari, Edge
- [ ] Add click pattern monitoring (AC: 2)
  - [ ] Track clicks on elements with data-action="promo"
  - [ ] Store click events with timestamps
  - [ ] Detect >3 clicks within 10 seconds
  - [ ] Calculate click velocity
  - [ ] Trigger investigation on rapid clicking
  - [ ] Log click patterns for analysis
- [ ] Implement right-click detection (AC: 3)
  - [ ] Add contextmenu event listener
  - [ ] Check if target has data-cloak="promotional"
  - [ ] Increment suspicion score by 50
  - [ ] Prevent default context menu on promotional content
  - [ ] Log right-click attempts
  - [ ] Trigger immediate investigation
- [ ] Create hover tracking system (AC: 4)
  - [ ] Track mouseenter/mouseleave on promotional links
  - [ ] Calculate hover duration
  - [ ] Detect hovering >3 seconds without clicking
  - [ ] Track multiple suspicious hovers (>2)
  - [ ] Store hover events with start/end times
  - [ ] Trigger investigation on extended hovering
- [ ] Implement mode revocation (AC: 5, 6)
  - [ ] Create triggerWhiteMode() method
  - [ ] Immediately remove .is-black-mode class
  - [ ] Add user to localStorage blacklist
  - [ ] Include reason for blacklisting
  - [ ] Update CloakProvider state
  - [ ] Ensure no visual flicker during revocation
- [ ] Add TDS API reporting (AC: 7)
  - [ ] Create reportInvestigation() method
  - [ ] Send event type and details to TDS
  - [ ] Include userId, fingerprint, and reason
  - [ ] Use existing tracker API service
  - [ ] Handle API errors gracefully
  - [ ] Log all investigation events locally
- [ ] Integrate with existing systems (AC: 5, 6)
  - [ ] Update CloakProvider to support investigation detection
  - [ ] Connect with blacklist from story 2.5
  - [ ] Coordinate with verification flow
  - [ ] Ensure atomic state updates
  - [ ] Add investigation state to Zustand store
- [ ] Add comprehensive logging (AC: 7)
  - [ ] Use cloakLogger.violation() for investigations
  - [ ] Include trace ID correlation
  - [ ] Log detection method and reason
  - [ ] Track false positive rates
  - [ ] Monitor detection effectiveness
- [ ] Write cross-browser tests (AC: 8)
  - [ ] Test DevTools detection in all browsers
  - [ ] Verify click pattern detection
  - [ ] Test right-click prevention
  - [ ] Verify hover tracking accuracy
  - [ ] Test blacklist functionality

## Dev Notes
### Previous Story Insights
- Story 2.1-2.4: Established cloaking infrastructure
- Story 2.5: Created client verification and blacklist
- This story adds the final security layer with active monitoring

### DevTools Detection Methods
Based on [Source: architecture/cloak.md#devtools-detection]:
```javascript
// Method 1: Window size comparison
const threshold = 160;
const devToolsOpen = 
  window.outerHeight - window.innerHeight > threshold ||
  window.outerWidth - window.innerWidth > threshold;

// Additional methods needed for reliability
```

### Click Pattern Detection
Based on [Source: architecture/cloak.md#click-monitoring]:
```javascript
logPromoClick() {
  this.events.push({type: 'promo_click', time: Date.now()});
  
  const recentClicks = this.events
    .filter(e => e.type === 'promo_click' && Date.now() - e.time < 10000);
  
  if (recentClicks.length > 3) {
    this.triggerWhiteMode('rapid_promo_clicks');
  }
}
```

### Right-Click Prevention
Based on [Source: architecture/cloak.md#right-click-detection]:
```javascript
document.addEventListener('contextmenu', (e) => {
  if (e.target.closest('[data-action="promo"]')) {
    e.preventDefault();
    this.suspicionScore += 50;
    this.triggerWhiteMode('right_click_promo');
  }
});
```

### Hover Tracking
Based on [Source: architecture/cloak.md#hover-monitoring]:
```javascript
// Track hovers >3 seconds
suspiciousHovering: (hovers) => 
  hovers.filter(h => h.duration > 3000).length > 2
```

### Mode Revocation Pattern
Based on [Source: architecture/cloak.md#investigation-response]:
```javascript
triggerWhiteMode(reason: string) {
  // Immediate revocation
  document.body.classList.remove('is-black-mode');
  
  // Add to blacklist
  const blacklist = new PersistentBlacklist();
  blacklist.addToBlacklist(userId, reason);
  
  // Report to TDS
  this.reportInvestigation(reason);
}
```

### Blacklist Integration
Based on [Source: architecture/cloak.md#blacklist-management]:
- Use localStorage for immediate blocking
- Sync with server for persistence
- Include fingerprint and reason
- Prevent future verifications

### Logging Strategy
Based on [Source: architecture/observability-strategy.md#cloak-logging]:
```javascript
cloakLogger.violation(traceId, {
  type: 'investigation_detected',
  reason: reason,
  method: detectionMethod,
  userId: hashedUserId,
  timestamp: new Date().toISOString()
});
```

### Performance Considerations
- DevTools check: 500ms intervals
- Hover tracking: Debounced events
- Click monitoring: Real-time
- Non-blocking execution required

### File Locations
Based on [Source: architecture/source-tree.md]:
```
src/
├── lib/
│   └── cloak/
│       └── detector.ts
└── providers/
    └── cloak-provider.tsx (update)
```

### Testing Approach
Based on [Source: architecture/testing-strategy.md]:
- Mock browser APIs for testing
- Simulate user interactions
- Test across browser matrix
- Verify no false positives

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-07 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record
### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_