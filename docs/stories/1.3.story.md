# Story 1.3: Article API Integration

## Status
Draft

## Story
**As a** product owner,
**I want** the system to fetch article content from our API,
**so that** content can be managed externally.

## Acceptance Criteria
1. Create API service layer with proper TypeScript interfaces
2. Implement server-side data fetching in page.tsx Server Component
3. Handle API errors gracefully with fallback content
4. Create Article interface matching API response structure
5. Implement proper error boundaries for failed requests
6. Add request timeout handling (max 3 seconds)
7. Cache article responses appropriately
8. Log API failures to console (Sentry integration comes later)

## Tasks / Subtasks
- [ ] Set up base HTTP client infrastructure (AC: 1, 6)
  - [ ] Create src/lib/http/client.ts with timeout support
  - [ ] Implement APIError class with status, code, and details
  - [ ] Add AbortController for request cancellation
  - [ ] Configure default timeout of 3000ms (per AC)
  - [ ] Support Next.js cache configuration options
- [ ] Create Article types and validation schemas (AC: 1, 4)
  - [ ] Create src/types/article.ts with Article interface
  - [ ] Create src/lib/validation/schemas/article.ts with Zod schema
  - [ ] Define fields: id, slug, title, content, excerpt, author, publishedAt, tags
  - [ ] Create ApiResponse<T> wrapper type for API responses
  - [ ] Export inferred TypeScript types from Zod schemas
- [ ] Build article API service layer (AC: 1, 3, 7)
  - [ ] Create src/lib/services/article/article.api.ts with 'server-only' import
  - [ ] Create src/lib/services/article/article.types.ts for types
  - [ ] Implement getArticleBySlug(slug: string) method
  - [ ] Add React.cache() wrapper for request deduplication
  - [ ] Configure caching with 5-minute revalidation for articles
  - [ ] Handle validation errors with proper error messages
- [ ] Update article page with server-side fetching (AC: 2)
  - [ ] Update src/app/(marketing)/article/[slug]/page.tsx
  - [ ] Call article service in the Server Component
  - [ ] Pass article data to child components
  - [ ] Remove placeholder content from story 1.2
  - [ ] Add proper TypeScript types for props
- [ ] Implement error handling (AC: 3, 5, 8)
  - [ ] Create custom error types (ArticleNotFoundError, etc.)
  - [ ] Add try-catch blocks with specific error handling
  - [ ] Log errors to console with structured format
  - [ ] Return appropriate error responses
  - [ ] Ensure error.tsx boundary catches API failures
- [ ] Add fallback content for errors (AC: 3)
  - [ ] Create fallback UI for when article fails to load
  - [ ] Show user-friendly error messages
  - [ ] Include retry guidance for users
  - [ ] Maintain layout consistency during errors
- [ ] Create mock API endpoint for development (AC: 2)
  - [ ] Create src/app/api/articles/[slug]/route.ts (temporary)
  - [ ] Return mock article data for testing
  - [ ] Simulate various error scenarios
  - [ ] Add artificial delay to test loading states
  - [ ] Include TODO comment to replace with real API
- [ ] Add environment configuration (AC: 1)
  - [ ] Update .env.example with API_BASE_URL
  - [ ] Add type-safe environment variable access
  - [ ] Document API configuration in comments
- [ ] Write basic integration tests (AC: 2, 3)
  - [ ] Test successful article fetching
  - [ ] Test timeout handling (3-second limit)
  - [ ] Test error scenarios
  - [ ] Test cache behavior

## Dev Notes
### Previous Story Insights
- Story 1.1: Set up Next.js 15.3.4 project with TypeScript, established directory structure
- Story 1.2: Created routing structure with /article/[slug] route, implemented layout and loading states

### API Service Architecture
Based on [Source: architecture/api-integration.md#server-only-service-layer-pattern]:
- All API services must use 'server-only' import to prevent client bundling
- Service structure: `/lib/services/[domain]/[domain].api.ts` and `.types.ts`
- Direct service calls in Server Components (no loading states needed)
- Return success/error objects from services

### HTTP Client Implementation
Based on [Source: architecture/api-integration.md#base-http-client]:
```typescript
- Timeout support with AbortController
- Default timeout: 5000ms (override to 3000ms per AC)
- Custom APIError class with status, code, details
- Automatic JSON content-type headers
- Next.js cache configuration support
```

### Type Validation
Based on [Source: architecture/type-safety-validation.md#comprehensive-api-response-validation]:
- Use Zod for runtime validation of API responses
- Define schemas first, derive types with z.infer
- Use parse() for critical paths (fail fast)
- Wrap validation errors with context
- Schema location: /lib/validation/schemas/

### Caching Strategy
Based on [Source: architecture/caching-strategy.md#caching-rules-for-different-content-types]:
- Article content: `revalidate: 300` (5 minutes)
- Use React.cache() for request-level deduplication
- Tag-based invalidation: tag articles with ['article', `article-${slug}`]
- No caching for error responses

### Error Handling
Based on [Source: architecture/development-standards.md#error-handling-standards]:
- Custom error classes extending base Error
- Structured error logging with context
- Type-safe error handling with Result pattern
- Error boundaries for component-level failures

### File Locations
Based on [Source: architecture/source-tree.md]:
```
src/
├── lib/
│   ├── http/
│   │   └── client.ts
│   ├── services/
│   │   └── article/
│   │       ├── article.api.ts
│   │       └── article.types.ts
│   └── validation/
│       └── schemas/
│           └── article.ts
├── types/
│   └── article.ts
└── app/
    ├── (marketing)/
    │   └── article/
    │       └── [slug]/
    │           └── page.tsx
    └── api/
        └── articles/
            └── [slug]/
                └── route.ts (temporary mock)
```

### Testing
Based on [Source: architecture/testing-strategy.md#msw-setup-for-api-mocking]:
- Use MSW for mocking API responses in tests
- Test timeout scenarios with delayed responses
- Verify error handling with various HTTP status codes
- Test cache behavior with repeated requests

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-07 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record
### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_