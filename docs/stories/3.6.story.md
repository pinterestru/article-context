# Story 3.6: Animated Promocode Modal

## Status
Draft

## Story
**As a** user,
**I want** an expanded view of promocode details,
**so that** I can see all offer information clearly.

## Acceptance Criteria
1. Create modal component using Radix UI Dialog
2. Trigger modal on "View Details" link click
3. Display large promocode with copy button
4. Show offer terms and conditions
5. Include prominent "Use Code" CTA button
6. Implement smooth open/close animations
7. Ensure modal is fully accessible (keyboard nav, focus trap)
8. Track modal open/close events for analytics

## Tasks / Subtasks
- [ ] Install and configure Radix UI Dialog (AC: 1)
  - [ ] Install @radix-ui/react-dialog if needed
  - [ ] Create src/components/ui/dialog.tsx (shadcn pattern)
  - [ ] Configure base dialog with Tailwind styles
  - [ ] Add overlay backdrop with animation
  - [ ] Set up portal rendering for proper z-index
  - [ ] Test dialog renders above all content
- [ ] Create PromoCodeModal component (AC: 1, 3, 4, 5)
  - [ ] Create src/components/promocode/PromoCodeModal.tsx
  - [ ] Define PromoCodeModalProps interface
  - [ ] Structure modal with header, body, footer sections
  - [ ] Display large promocode in monospace font
  - [ ] Include copy button with success feedback
  - [ ] Show terms and conditions section
- [ ] Add trigger to PromoCodeWidget (AC: 2)
  - [ ] Update PromoCodeWidget with "View Details" link
  - [ ] Make link keyboard accessible
  - [ ] Style link appropriately for each variant
  - [ ] Pass promocode data to modal
  - [ ] Control modal open state
  - [ ] Test trigger interaction
- [ ] Implement modal animations (AC: 6)
  - [ ] Add fade-in animation for overlay (300ms)
  - [ ] Implement scale/slide animation for content
  - [ ] Use data-state for animation triggers
  - [ ] Add smooth exit animations
  - [ ] Respect prefers-reduced-motion
  - [ ] Test animation performance
- [ ] Build modal content sections (AC: 3, 4, 5)
  - [ ] Create header with close button
  - [ ] Display promocode in large, centered format
  - [ ] Add one-click copy functionality from story 3.3
  - [ ] Create collapsible terms section
  - [ ] Style "Use Code" CTA prominently
  - [ ] Ensure responsive layout on mobile
- [ ] Implement accessibility features (AC: 7)
  - [ ] Add proper ARIA labels to all elements
  - [ ] Implement focus trap with Radix Dialog
  - [ ] Set initial focus on close button
  - [ ] Support Escape key to close
  - [ ] Add screen reader announcements
  - [ ] Test with keyboard navigation
- [ ] Add analytics tracking (AC: 8)
  - [ ] Track modal open events with promocode
  - [ ] Track modal close events with duration
  - [ ] Track CTA clicks from modal
  - [ ] Track copy actions within modal
  - [ ] Include modal context in events
  - [ ] Test event firing accuracy
- [ ] Create mobile-optimized layout (AC: 3, 5, 7)
  - [ ] Use full-screen modal on mobile
  - [ ] Ensure touch-friendly button sizes
  - [ ] Add swipe-down gesture to close
  - [ ] Test on various device sizes
  - [ ] Optimize for one-handed use
  - [ ] Add haptic feedback for interactions
- [ ] Write comprehensive tests (AC: 1-8)
  - [ ] Unit test modal component
  - [ ] Test animation states
  - [ ] Test keyboard navigation
  - [ ] Test analytics events
  - [ ] Test accessibility with react-testing-library
  - [ ] E2E test modal flow

## Dev Notes
### Previous Story Insights
- PromoCodeWidget from story 3.2 needs "View Details" trigger
- Copy functionality from story 3.3 to be reused
- Analytics patterns from story 3.5 for event tracking
- Modal only appears for .is-black-mode users

### Radix UI Dialog Setup
Based on [Source: architecture/tech-stack.md]:
```typescript
// src/components/ui/dialog.tsx (shadcn pattern)
'use client';

import * as React from 'react';
import * as DialogPrimitive from '@radix-ui/react-dialog';
import { cn } from '@/lib/utils';

const Dialog = DialogPrimitive.Root;
const DialogTrigger = DialogPrimitive.Trigger;
const DialogPortal = DialogPrimitive.Portal;

const DialogOverlay = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Overlay
    ref={ref}
    className={cn(
      'fixed inset-0 z-50 bg-black/50 backdrop-blur-sm',
      'data-[state=open]:animate-in data-[state=closed]:animate-out',
      'data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0',
      className
    )}
    {...props}
  />
));
DialogOverlay.displayName = DialogPrimitive.Overlay.displayName;
```

### PromoCodeModal Component Structure
Based on [Source: architecture/component-standards.md]:
```typescript
export interface PromoCodeModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  code: string;
  discount: string;
  description?: string;
  expiresAt?: string;
  terms?: string[];
  targetUrl: string;
}

export function PromoCodeModal({
  open,
  onOpenChange,
  code,
  discount,
  description,
  expiresAt,
  terms,
  targetUrl
}: PromoCodeModalProps) {
  // Track modal open
  React.useEffect(() => {
    if (open) {
      analytics.promocodeInteraction({
        action: 'modal_opened',
        code,
        articleSlug: window.location.pathname,
        traceId: window.__TRACE_ID__
      });
    }
  }, [open, code]);

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-md">
        {/* Modal content */}
      </DialogContent>
    </Dialog>
  );
}
```

### Animation Styles
Based on [Source: architecture/styling-guidelines.md]:
```css
/* Animation classes using Tailwind */
.animate-in {
  animation-duration: var(--animation-normal); /* 300ms */
  animation-fill-mode: both;
}

.fade-in-0 {
  animation-name: fadeIn;
}

.slide-in-from-bottom-2 {
  animation-name: slideInFromBottom;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideInFromBottom {
  from { transform: translateY(0.5rem); }
  to { transform: translateY(0); }
}
```

### Copy Integration
Based on [Source: story 3.3 - React 19 Optimistic Copy Pattern]:
```typescript
// Reuse copy functionality from PromoCodeWidget
const [copied, setCopied] = useState(false);
const [optimisticCopied, setOptimisticCopied] = useOptimistic(
  copied,
  (state, newValue: boolean) => newValue
);

// Large promocode display with copy
<div className="text-center py-8">
  <div className="text-4xl font-mono font-bold mb-4">{code}</div>
  <button
    onClick={handleCopy}
    className={cn(
      'px-6 py-3 rounded-lg transition-all duration-200',
      optimisticCopied 
        ? 'bg-green-500 text-white' 
        : 'bg-secondary hover:bg-secondary/80'
    )}
  >
    {optimisticCopied ? 'Copied!' : 'Copy Code'}
  </button>
</div>
```

### Accessibility Implementation
Based on [Source: architecture/user-interface-design-goals.md#accessibility-wcag-aa]:
```typescript
<DialogContent
  aria-labelledby="promocode-title"
  aria-describedby="promocode-description"
>
  <DialogHeader>
    <DialogTitle id="promocode-title">
      {discount} Off Your Purchase
    </DialogTitle>
    <DialogClose className="absolute right-4 top-4" />
  </DialogHeader>
  
  <div id="promocode-description">
    {/* Content with proper semantic structure */}
  </div>
</DialogContent>
```

### Mobile Layout
```typescript
// Responsive modal sizing
<DialogContent className={cn(
  'fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg',
  'translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background',
  'p-6 shadow-lg duration-200',
  'sm:rounded-lg', // Rounded on desktop
  'max-h-[90vh] overflow-y-auto', // Scrollable on mobile
  // Full screen on mobile
  'h-full w-full sm:h-auto sm:w-auto',
  'rounded-none sm:rounded-lg'
)}>
```

### Analytics Events
Based on [Source: architecture/observability-strategy.md]:
```typescript
// Track all modal interactions
analytics.promocodeInteraction({
  action: 'modal_opened' | 'modal_closed' | 'modal_cta_clicked',
  code: code,
  modalDuration?: number, // Time modal was open
  articleSlug: window.location.pathname,
  position: 'modal',
  traceId: window.__TRACE_ID__
});
```

### File Locations
Based on [Source: architecture/source-tree.md]:
```
src/
├── components/
│   ├── ui/
│   │   └── dialog.tsx
│   └── promocode/
│       └── PromoCodeModal.tsx
```

### Testing
#### Test File Locations
- Component tests: `src/components/promocode/__tests__/PromoCodeModal.test.tsx`
- E2E tests: `e2e/promocode-modal.spec.ts`

#### Testing Standards
Based on [Source: architecture/testing-strategy.md]:
- Test modal open/close states
- Verify focus management
- Test keyboard navigation
- Mock analytics calls
- Test responsive behavior

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-07 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record
### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_