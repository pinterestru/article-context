# Story 4.5: Sentry Error Monitoring

## Status
Draft

## Story
**As a** developer,
**I want** comprehensive error tracking,
**so that** we can maintain system reliability.

## Acceptance Criteria
1. Install and configure Sentry for Next.js
2. Set up source maps for meaningful stack traces
3. Configure error boundaries with Sentry reporting
4. Implement performance monitoring for Core Web Vitals
5. Set up alerts for error rate spikes
6. Add custom context (cloak state, user type)
7. Configure sampling rates for cost control
8. Test error reporting in production environment

## Tasks / Subtasks
- [ ] Install and configure Sentry SDK (AC: 1)
  - [ ] Install @sentry/nextjs package
  - [ ] Create sentry.client.config.ts
  - [ ] Create sentry.server.config.ts
  - [ ] Create sentry.edge.config.ts
  - [ ] Configure Next.js plugin in next.config.js
  - [ ] Test basic error capture
- [ ] Set up source maps (AC: 2)
  - [ ] Configure source map generation in build
  - [ ] Set up source map upload to Sentry
  - [ ] Configure release tracking
  - [ ] Test stack traces show original source
  - [ ] Implement source map security headers
  - [ ] Verify production builds work correctly
- [ ] Implement error boundaries (AC: 3)
  - [ ] Create global error boundary (app/global-error.tsx)
  - [ ] Create page-level error boundary (app/error.tsx)
  - [ ] Add Sentry error capture to boundaries
  - [ ] Include user feedback widget
  - [ ] Test error boundary fallback UI
  - [ ] Ensure errors are properly logged
- [ ] Configure performance monitoring (AC: 4)
  - [ ] Enable BrowserTracing integration
  - [ ] Configure Core Web Vitals tracking
  - [ ] Set up custom performance metrics
  - [ ] Track cloak decision latency
  - [ ] Monitor API response times
  - [ ] Test performance data collection
- [ ] Create alert configurations (AC: 5)
  - [ ] Define error rate spike thresholds
  - [ ] Set up issue frequency alerts
  - [ ] Configure performance degradation alerts
  - [ ] Create custom metric alerts
  - [ ] Set up notification channels
  - [ ] Test alert triggering
- [ ] Implement custom context enrichment (AC: 6)
  - [ ] Add cloak mode to all errors
  - [ ] Include user type and source
  - [ ] Add trace ID correlation
  - [ ] Include article context
  - [ ] Track feature flags state
  - [ ] Test context appears in Sentry
- [ ] Configure sampling strategies (AC: 7)
  - [ ] Set error sampling rates by environment
  - [ ] Configure performance sampling
  - [ ] Implement dynamic sampling rules
  - [ ] Add cost control mechanisms
  - [ ] Monitor sampling effectiveness
  - [ ] Document sampling decisions
- [ ] Create production testing suite (AC: 8)
  - [ ] Build error testing endpoints
  - [ ] Create performance test scenarios
  - [ ] Implement smoke tests for Sentry
  - [ ] Add monitoring dashboard
  - [ ] Document testing procedures
  - [ ] Verify production deployment
- [ ] Integrate with existing observability (AC: 1-8)
  - [ ] Ensure trace ID correlation works
  - [ ] Link errors to session recordings
  - [ ] Connect with analytics events
  - [ ] Update debug dashboard
  - [ ] Test cross-platform correlation
  - [ ] Document integration points
- [ ] Write comprehensive tests (AC: 1-8)
  - [ ] Unit test Sentry configuration
  - [ ] Test error boundary behavior
  - [ ] Mock Sentry in test environment
  - [ ] Test context enrichment
  - [ ] Verify sampling logic
  - [ ] E2E test error reporting flow

## Dev Notes
### Previous Story Insights
- Story 4.1-4.3 established analytics infrastructure with GTM, GA4, and Yandex
- Story 4.4 implemented PostHog with session recording controls
- Trace ID system (window.__TRACE_ID__) established for correlation
- Cloak mode detection available via body class
- Privacy controls implemented for session recording

### Sentry Installation and Configuration
Based on [Source: architecture/observability-strategy.md#sentry-integration]:
```typescript
// sentry.client.config.ts
import * as Sentry from '@sentry/nextjs'

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  environment: process.env.NODE_ENV,
  
  // Performance Monitoring
  integrations: [
    new Sentry.BrowserTracing({
      routingInstrumentation: Sentry.nextRouterInstrumentation,
      tracingOrigins: [
        'localhost',
        process.env.NEXT_PUBLIC_APP_URL,
        /^\//,
      ],
    }),
    new Sentry.Replay({
      maskAllText: false,
      blockAllMedia: false,
      // Only record when error occurs
      sessionSampleRate: 0,
      errorSampleRate: 1.0,
    }),
  ],
  
  // Sampling
  tracesSampleRate: process.env.NODE_ENV === 'production' ? 0.1 : 1.0,
  replaysSessionSampleRate: 0,
  replaysOnErrorSampleRate: 1.0,
  
  // Data scrubbing
  beforeSend(event, hint) {
    // Add trace context
    if (typeof window !== 'undefined') {
      const traceId = window.__TRACE_ID__
      if (traceId) {
        event.tags = { ...event.tags, trace_id: traceId }
        event.contexts = {
          ...event.contexts,
          trace: { trace_id: traceId },
        }
      }
      
      // Add cloak context
      const isBlackMode = document.body.classList.contains('is-black-mode')
      event.tags = {
        ...event.tags,
        cloak_mode: isBlackMode ? 'black' : 'white',
      }
    }
    
    // Redact sensitive data
    if (event.request?.cookies) {
      event.request.cookies = '[REDACTED]'
    }
    if (event.request?.headers?.authorization) {
      event.request.headers.authorization = '[REDACTED]'
    }
    
    return event
  },
  
  // Ignore certain errors
  ignoreErrors: [
    // Browser extensions
    'top.GLOBALS',
    // Random network errors
    'Non-Error promise rejection captured',
    // Ignore tracking prevention errors
    'Failed to fetch',
  ],
})
```

### Server-Side Configuration
```typescript
// sentry.server.config.ts
import * as Sentry from '@sentry/nextjs'

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  
  // Server-specific settings
  tracesSampleRate: process.env.NODE_ENV === 'production' ? 0.1 : 1.0,
  
  // Profiling (Node.js 16+)
  profilesSampleRate: 0.1,
  
  beforeSend(event) {
    // Server-side context enrichment
    event.server_name = process.env.HOSTNAME || 'unknown'
    event.tags = {
      ...event.tags,
      runtime: 'nodejs',
      node_version: process.version,
    }
    
    return event
  },
})
```

### Edge Runtime Configuration
```typescript
// sentry.edge.config.ts
import * as Sentry from '@sentry/nextjs'

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  
  // Edge-specific settings
  tracesSampleRate: 0.1,
  
  beforeSend(event) {
    event.tags = {
      ...event.tags,
      runtime: 'edge',
    }
    return event
  },
})
```

### Next.js Configuration
Based on Next.js 15 requirements:
```javascript
// next.config.js
const { withSentryConfig } = require('@sentry/nextjs')

const sentryWebpackPluginOptions = {
  // Organization and project
  org: process.env.SENTRY_ORG,
  project: process.env.SENTRY_PROJECT,
  
  // Auth token for source map upload
  authToken: process.env.SENTRY_AUTH_TOKEN,
  
  // Suppresses source map uploading logs during build
  silent: true,
  
  // Upload source maps for production builds
  widenClientFileUpload: true,
  
  // Hides source maps from generated client bundles
  hideSourceMaps: true,
  
  // Disables automatic release creation
  disableLogger: true,
}

module.exports = withSentryConfig(
  nextConfig,
  sentryWebpackPluginOptions
)
```

### Error Boundary Implementation
Based on [Source: architecture/development-standards.md#error-handling-standards]:
```typescript
// app/global-error.tsx
'use client'

import * as Sentry from '@sentry/nextjs'
import { useEffect } from 'react'

export default function GlobalError({
  error,
  reset,
}: {
  error: Error & { digest?: string }
  reset: () => void
}) {
  useEffect(() => {
    // Log to Sentry
    Sentry.captureException(error, {
      tags: {
        error_boundary: 'global',
      },
      contexts: {
        error: {
          digest: error.digest,
        },
      },
    })
  }, [error])

  return (
    <html>
      <body>
        <div className="error-container">
          <h2>Something went wrong!</h2>
          <details>
            <summary>Error details</summary>
            <pre>{error.message}</pre>
          </details>
          <button onClick={reset}>Try again</button>
          <button 
            onClick={() => {
              const eventId = Sentry.lastEventId()
              Sentry.showReportDialog({ eventId })
            }}
          >
            Report this error
          </button>
        </div>
      </body>
    </html>
  )
}

// app/error.tsx
'use client'

import { useEffect } from 'react'
import * as Sentry from '@sentry/nextjs'

export default function Error({
  error,
  reset,
}: {
  error: Error & { digest?: string }
  reset: () => void
}) {
  useEffect(() => {
    Sentry.captureException(error, {
      tags: {
        error_boundary: 'page',
      },
    })
  }, [error])

  return (
    <div className="error-page">
      <h2>Oops! Something went wrong</h2>
      <p>We've been notified and are working on a fix.</p>
      <button onClick={reset}>Try again</button>
    </div>
  )
}
```

### Performance Monitoring Setup
Based on Core Web Vitals requirements:
```typescript
// src/lib/analytics/performance.ts
import * as Sentry from '@sentry/nextjs'
import { getCLS, getFID, getLCP, getFCP, getTTFB } from 'web-vitals'

export function initPerformanceMonitoring() {
  // Core Web Vitals
  getCLS((metric) => {
    Sentry.addBreadcrumb({
      category: 'web-vitals',
      message: `CLS: ${metric.value}`,
      level: metric.value > 0.1 ? 'warning' : 'info',
    })
    
    // Send as custom metric
    Sentry.getCurrentHub().getClient()?.captureEvent({
      measurements: {
        cls: { value: metric.value, unit: '' },
      },
    })
  })

  getLCP((metric) => {
    Sentry.addBreadcrumb({
      category: 'web-vitals',
      message: `LCP: ${metric.value}ms`,
      level: metric.value > 2500 ? 'warning' : 'info',
    })
    
    Sentry.getCurrentHub().getClient()?.captureEvent({
      measurements: {
        lcp: { value: metric.value, unit: 'millisecond' },
      },
    })
  })

  getFID((metric) => {
    Sentry.addBreadcrumb({
      category: 'web-vitals',
      message: `FID: ${metric.value}ms`,
      level: metric.value > 100 ? 'warning' : 'info',
    })
  })

  // Custom metrics for cloaking
  measureCloakDecisionLatency()
}

function measureCloakDecisionLatency() {
  if (typeof window !== 'undefined') {
    const startTime = performance.now()
    
    // Listen for cloak decision
    window.addEventListener('cloak-decision-complete', () => {
      const duration = performance.now() - startTime
      
      Sentry.addBreadcrumb({
        category: 'performance',
        message: `Cloak decision: ${duration}ms`,
        level: duration > 200 ? 'warning' : 'info',
      })
      
      // Create transaction
      const transaction = Sentry.startTransaction({
        name: 'cloak-decision',
        op: 'cloak',
      })
      
      transaction.setMeasurement('duration', duration, 'millisecond')
      transaction.finish()
    })
  }
}
```

### Custom Context Enrichment
Based on [Source: architecture/observability-strategy.md#sentry-integration]:
```typescript
// src/lib/analytics/sentry-context.ts
import * as Sentry from '@sentry/nextjs'

export function enrichSentryContext() {
  if (typeof window === 'undefined') return
  
  // Set user context
  const userIdentification = UserIdentification.getInstance()
  const userId = userIdentification.getOrCreateAnonymousId()
  
  Sentry.setUser({
    id: userId,
    ip_address: '{{auto}}', // Let Sentry determine IP
  })
  
  // Set initial tags
  Sentry.setTags({
    trace_id: window.__TRACE_ID__,
    cloak_mode: document.body.classList.contains('is-black-mode') ? 'black' : 'white',
    source: getTrafficSource(),
    feature_flags: JSON.stringify(posthog?.getFeatureFlags() || {}),
  })
  
  // Set custom context
  Sentry.setContext('session', {
    start_time: new Date().toISOString(),
    article_slug: window.location.pathname.split('/').pop(),
    has_interacted: sessionStorage.getItem('promocode_interacted') === 'true',
  })
  
  // Watch for cloak mode changes
  const observer = new MutationObserver(() => {
    const isBlackMode = document.body.classList.contains('is-black-mode')
    Sentry.setTag('cloak_mode', isBlackMode ? 'black' : 'white')
  })
  
  observer.observe(document.body, {
    attributes: true,
    attributeFilter: ['class'],
  })
}

function getTrafficSource(): string {
  const params = new URLSearchParams(window.location.search)
  if (params.get('gclid')) return 'google_ads'
  if (params.get('yclid')) return 'yandex_direct'
  if (params.get('fbclid')) return 'facebook'
  return 'organic'
}
```

### Sampling Configuration
Based on cost control requirements:
```typescript
// src/lib/analytics/sentry-sampling.ts
export const sentryDynamicSamplingContext = {
  // Error sampling rules
  errorSampleRate: (context: any) => {
    // Always capture errors in development
    if (process.env.NODE_ENV !== 'production') return 1.0
    
    // Higher sampling for critical errors
    if (context.tags?.level === 'fatal') return 1.0
    if (context.tags?.level === 'error') return 0.5
    
    // Lower sampling for warnings
    if (context.tags?.level === 'warning') return 0.1
    
    // Default
    return 0.25
  },
  
  // Transaction sampling rules
  tracesSampleRate: (context: any) => {
    // Always sample in development
    if (process.env.NODE_ENV !== 'production') return 1.0
    
    // Higher sampling for important operations
    if (context.op === 'cloak') return 0.5
    if (context.op === 'navigation') return 0.2
    if (context.op === 'http.client') return 0.1
    
    // Lower sampling for assets
    if (context.op === 'resource.script') return 0.01
    if (context.op === 'resource.css') return 0.01
    
    // Default
    return 0.1
  },
}
```

### Alert Configuration
Example alert rules for Sentry:
```typescript
// Alert rules to configure in Sentry dashboard
export const sentryAlertRules = {
  errorRateSpike: {
    name: 'Error Rate Spike',
    conditions: [
      {
        id: 'sentry.rules.conditions.event_frequency.EventFrequencyCondition',
        value: 10, // 10 events
        interval: '5m', // in 5 minutes
      },
    ],
    actions: [
      {
        id: 'sentry.integrations.slack.notify_action.SlackNotifyServiceAction',
        channel: '#alerts',
      },
    ],
  },
  
  performanceDegradation: {
    name: 'Performance Degradation',
    dataset: 'transactions',
    query: 'event.type:transaction transaction:"/article/*"',
    aggregate: 'p95(transaction.duration)',
    timeWindow: '10m',
    triggers: [
      {
        label: 'critical',
        alertThreshold: 3000, // 3 seconds
      },
      {
        label: 'warning',
        alertThreshold: 2000, // 2 seconds
      },
    ],
  },
  
  cloakDecisionFailure: {
    name: 'Cloak Decision Failures',
    query: 'event.type:error message:"cloak decision failed"',
    timeWindow: '5m',
    triggers: [
      {
        label: 'critical',
        alertThreshold: 5,
      },
    ],
  },
}
```

### Environment Variables
Based on [Source: architecture/environment-configuration.md]:
```env
# Sentry
NEXT_PUBLIC_SENTRY_DSN=https://xxxxx@o0.ingest.sentry.io/0
SENTRY_ORG=your-org
SENTRY_PROJECT=affiliate-article-ui
SENTRY_AUTH_TOKEN=sntrys_xxxxxxxxxxxxxxxxxxxxx
SENTRY_ENVIRONMENT=production
```

### Testing Utilities
```typescript
// src/lib/analytics/__tests__/sentry.test.ts
import * as Sentry from '@sentry/nextjs'

// Mock Sentry for tests
vi.mock('@sentry/nextjs', () => ({
  init: vi.fn(),
  captureException: vi.fn(),
  captureMessage: vi.fn(),
  setUser: vi.fn(),
  setTags: vi.fn(),
  setContext: vi.fn(),
  addBreadcrumb: vi.fn(),
  startTransaction: vi.fn(() => ({
    setMeasurement: vi.fn(),
    finish: vi.fn(),
  })),
}))

// Test helper
export function triggerTestError(type: 'error' | 'unhandled' | 'promise') {
  switch (type) {
    case 'error':
      throw new Error('Test error for Sentry')
    case 'unhandled':
      setTimeout(() => {
        throw new Error('Unhandled test error')
      }, 0)
      break
    case 'promise':
      Promise.reject(new Error('Unhandled promise rejection'))
      break
  }
}
```

### File Locations
Based on [Source: architecture/source-tree.md]:
```
├── sentry.client.config.ts
├── sentry.server.config.ts
├── sentry.edge.config.ts
├── src/
│   ├── app/
│   │   ├── global-error.tsx
│   │   └── error.tsx
│   └── lib/
│       └── analytics/
│           ├── sentry.ts
│           ├── sentry-context.ts
│           ├── sentry-sampling.ts
│           └── performance.ts
```

### Testing
#### Test File Locations
- Sentry config: `src/lib/analytics/__tests__/sentry.test.ts`
- Error boundaries: `src/app/__tests__/error.test.tsx`
- Performance monitoring: `src/lib/analytics/__tests__/performance.test.ts`
- E2E tests: `e2e/error-tracking.spec.ts`

#### Testing Standards
Based on [Source: architecture/testing-strategy.md]:
- Mock Sentry SDK in unit tests
- Test error boundary rendering and reporting
- Verify context enrichment
- Test sampling logic
- E2E test error reporting flow
- Verify source maps work in staging

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-07 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record
### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_