# Story 3.3: One-Click Copy Functionality

## Status
Draft

## Story
**As a** user,
**I want** to copy promocodes with a single click,
**so that** I can easily use them on the partner site.

## Acceptance Criteria
1. Implement clipboard copy on promocode click/tap
2. Show animated success state after copy (checkmark, "Copied!")
3. Provide haptic feedback on mobile devices if available
4. Fall back to manual selection if clipboard API fails
5. Change button text from "Copy Code" to "Copied!" temporarily
6. Reset copy state after 3 seconds
7. Track successful copy events for analytics
8. Test across all major browsers and mobile devices

## Tasks / Subtasks
- [ ] Enhance PromoCodeWidget with copy functionality (AC: 1, 5)
  - [ ] Update src/components/widgets/PromoCodeWidget.tsx
  - [ ] Add copy button/clickable area to component
  - [ ] Implement handleCopy async function
  - [ ] Use navigator.clipboard.writeText API
  - [ ] Update button text dynamically
  - [ ] Make entire code area clickable for better UX
- [ ] Implement React 19 optimistic updates (AC: 2, 6)
  - [ ] Add useOptimistic hook for immediate feedback
  - [ ] Add useTransition for smooth state changes
  - [ ] Create optimisticCopied state
  - [ ] Show success state immediately on click
  - [ ] Implement 3-second auto-reset with setTimeout
  - [ ] Handle state cleanup on unmount
- [ ] Add visual success animations (AC: 2)
  - [ ] Replace copy icon with checkmark on success
  - [ ] Add green ring effect (ring-2 ring-green-500)
  - [ ] Implement pulse animation on bottom border
  - [ ] Change button background to green
  - [ ] Use transition-all duration-200 for smoothness
  - [ ] Add scale effect on click (scale-95 to scale-100)
- [ ] Implement clipboard API fallback (AC: 4)
  - [ ] Detect clipboard API availability
  - [ ] Create hidden textarea fallback method
  - [ ] Implement text selection and document.execCommand
  - [ ] Test fallback on older browsers
  - [ ] Ensure seamless experience regardless of method
  - [ ] Add console warnings for debugging
- [ ] Add haptic feedback support (AC: 3)
  - [ ] Check for vibration API availability
  - [ ] Implement navigator.vibrate() call
  - [ ] Use subtle vibration pattern (e.g., 10ms)
  - [ ] Wrap in try-catch for safety
  - [ ] Test on various mobile devices
  - [ ] Make haptic feedback optional/configurable
- [ ] Integrate analytics tracking (AC: 7)
  - [ ] Import analytics from observability module
  - [ ] Track promocode copy events
  - [ ] Include code, articleSlug, position metadata
  - [ ] Use traceId for correlation
  - [ ] Fire event only on successful copy
  - [ ] Add timing metrics for performance
- [ ] Handle error cases gracefully (AC: 2, 4)
  - [ ] Wrap clipboard operations in try-catch
  - [ ] Revert optimistic state on error
  - [ ] Log errors to console for debugging
  - [ ] Don't show error UI (silent failure)
  - [ ] Ensure button remains functional after error
  - [ ] Test with clipboard permissions denied
- [ ] Add accessibility features (AC: 1, 2)
  - [ ] Add aria-label for copy button
  - [ ] Announce copy success to screen readers
  - [ ] Use aria-live region for status updates
  - [ ] Ensure keyboard navigation works
  - [ ] Add focus styles for keyboard users
  - [ ] Test with screen reader software
- [ ] Write comprehensive tests (AC: 8)
  - [ ] Unit test copy functionality
  - [ ] Mock clipboard API for testing
  - [ ] Test optimistic update behavior
  - [ ] Test error handling scenarios
  - [ ] Test timer cleanup on unmount
  - [ ] E2E test across browser matrix
  - [ ] Test mobile interactions

## Dev Notes
### Previous Story Insights
- Story 3.2 created the PromoCodeWidget component structure
- Widget supports inline, card, and banner variants
- Component uses forwardRef pattern
- Already has basic styling and reveal animation

### React 19 Optimistic Copy Pattern
Based on [Source: architecture/react-19-features.md#useoptimistic-for-promocode-interactions]:
```typescript
'use client';

import { useOptimistic, useTransition } from 'react';

// Inside PromoCodeWidget component
const [copied, setCopied] = useState(false);
const [optimisticCopied, setOptimisticCopied] = useOptimistic(
  copied,
  (state, newValue: boolean) => newValue
);
const [isPending, startTransition] = useTransition();

const handleCopy = async () => {
  setOptimisticCopied(true); // Immediate feedback
  
  startTransition(async () => {
    try {
      await navigator.clipboard.writeText(code);
      setCopied(true);
      
      // Track analytics
      analytics.promocodeInteraction({
        action: 'copied',
        code,
        articleSlug,
        traceId
      });
      
      // Reset after 3 seconds
      setTimeout(() => {
        setCopied(false);
        setOptimisticCopied(false);
      }, 3000);
    } catch (error) {
      console.error('Copy failed:', error);
      setOptimisticCopied(false); // Revert on error
    }
  });
};
```

### Success Animation Styles
Based on [Source: architecture/react-19-features.md#advanced-pattern-optimistic-cart-updates]:
```typescript
// Dynamic styling based on copy state
className={cn(
  'relative px-4 py-2 font-medium transition-all duration-200',
  optimisticCopied 
    ? 'bg-green-500 text-white ring-2 ring-green-500' 
    : 'bg-primary text-primary-foreground hover:bg-primary/90'
)}

// Bottom pulse indicator
{optimisticCopied && (
  <div className="absolute bottom-0 left-0 h-1 w-full bg-green-400 animate-pulse" />
)}
```

### Analytics Integration
Based on [Source: architecture/observability-strategy.md#posthog-analytics-integration]:
```typescript
import { analytics } from '@/lib/analytics';

// Track copy event
analytics.promocodeInteraction({
  action: 'copied',
  code: code,
  articleSlug: articleSlug,
  position: widgetPosition, // e.g., 'inline', 'sidebar'
  traceId: getTraceId()
});
```

### Clipboard API Fallback
```typescript
const copyToClipboard = async (text: string): Promise<void> => {
  // Modern API
  if (navigator.clipboard && window.isSecureContext) {
    return navigator.clipboard.writeText(text);
  }
  
  // Fallback for older browsers
  const textArea = document.createElement('textarea');
  textArea.value = text;
  textArea.style.position = 'fixed';
  textArea.style.left = '-999999px';
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();
  
  try {
    document.execCommand('copy');
  } finally {
    textArea.remove();
  }
};
```

### Haptic Feedback Implementation
```typescript
const triggerHapticFeedback = () => {
  if ('vibrate' in navigator) {
    try {
      navigator.vibrate(10); // 10ms subtle feedback
    } catch (error) {
      console.log('Haptic feedback not available');
    }
  }
};
```

### Component Button Structure
```typescript
<button
  onClick={handleCopy}
  className={cn(/* dynamic classes */)}
  aria-label={optimisticCopied ? 'Code copied' : 'Copy promo code'}
>
  {optimisticCopied ? (
    <>
      <CheckIcon className="w-4 h-4 mr-2" />
      Copied!
    </>
  ) : (
    <>
      <CopyIcon className="w-4 h-4 mr-2" />
      Copy Code
    </>
  )}
</button>
```

### Accessibility Considerations
Based on [Source: architecture/user-interface-design-goals.md#accessibility-wcag-aa]:
- Use aria-live="polite" for copy status announcements
- Ensure 3:1 contrast ratio for success state
- Keyboard accessible with Enter/Space activation
- Focus visible styles for keyboard navigation

### Testing Approach
Based on [Source: architecture/testing-strategy.md]:
- Mock navigator.clipboard in tests
- Test with clipboard API unavailable
- Verify analytics events fired
- Test auto-reset timer behavior
- Check accessibility with react-testing-library

### File Locations
Based on [Source: architecture/source-tree.md]:
```
src/
├── components/
│   └── widgets/
│       └── PromoCodeWidget.tsx (update existing)
├── lib/
│   └── analytics/
│       └── index.ts (use existing)
```

### Testing
#### Test Updates
- Update existing PromoCodeWidget tests
- Add copy functionality test cases
- Mock clipboard and vibration APIs
- Test optimistic update flow
- Verify analytics integration

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-07 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record
### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_