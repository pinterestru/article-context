# Story 4.2: Google Analytics 4 Configuration

## Status
Draft

## Story
**As a** business analyst,
**I want** GA4 tracking implemented,
**so that** we can analyze traffic sources and user behavior.

## Acceptance Criteria
1. Configure GA4 tag in GTM with measurement ID
2. Set up Enhanced Ecommerce events for conversions
3. Track custom dimensions for cloak state and user type
4. Implement scroll tracking for content engagement
5. Set up conversion goals for promocode copies and clicks
6. Configure audience definitions for remarketing
7. Test cross-domain tracking for partner redirects
8. Verify GDPR compliance mode configuration

## Tasks / Subtasks
- [ ] Configure GA4 tag in GTM container (AC: 1)
  - [ ] Add GA4 Configuration tag in GTM interface
  - [ ] Set measurement ID from NEXT_PUBLIC_GA4_MEASUREMENT_ID
  - [ ] Configure tag to fire on All Pages trigger
  - [ ] Set up custom dimensions mapping in GTM
  - [ ] Disable automatic pageview tracking (manual control)
  - [ ] Test tag fires correctly in GTM Preview mode
- [ ] Create GA4 initialization and consent (AC: 8)
  - [ ] Create src/lib/analytics/ga4.ts for initialization
  - [ ] Implement consent mode with default denied state
  - [ ] Add consent update functions for GDPR compliance
  - [ ] Configure wait_for_update timeout
  - [ ] Integrate with cookie consent banner (if exists)
  - [ ] Test consent states update correctly
- [ ] Implement custom dimensions setup (AC: 3)
  - [ ] Define custom dimensions in GA4 property settings
  - [ ] Map trace_id to custom dimension 1
  - [ ] Map cloak_mode to custom dimension 2  
  - [ ] Map click_id (gclid/yclid) to dimension 3
  - [ ] Map article_slug to dimension 4
  - [ ] Update GTM tags to send dimension values
- [ ] Create Enhanced Ecommerce events (AC: 2)
  - [ ] Create src/lib/analytics/ga4-events.ts
  - [ ] Implement view_item for article views
  - [ ] Implement view_promotion for promocode display
  - [ ] Implement select_promotion for promocode clicks
  - [ ] Add purchase event for conversion tracking
  - [ ] Test all ecommerce events fire correctly
- [ ] Implement scroll tracking (AC: 4)
  - [ ] Create scroll depth tracking in GTM
  - [ ] Configure triggers at 25%, 50%, 75%, 100%
  - [ ] Add scroll events to GA4 with article context
  - [ ] Track time on page alongside scroll depth
  - [ ] Test scroll tracking on different devices
  - [ ] Ensure performance impact is minimal
- [ ] Set up conversion tracking (AC: 5)
  - [ ] Create conversion events for promocode_copied
  - [ ] Create conversion events for promocode_clicked
  - [ ] Configure conversion value tracking
  - [ ] Set up funnel visualization in GA4
  - [ ] Map conversions to business goals
  - [ ] Test conversion tracking end-to-end
- [ ] Configure remarketing audiences (AC: 6)
  - [ ] Create audience for black mode visitors
  - [ ] Create audience for promocode interactors
  - [ ] Set up predictive audiences for likely converters
  - [ ] Configure membership duration rules
  - [ ] Enable Google Ads remarketing
  - [ ] Test audience population in GA4
- [ ] Implement cross-domain tracking (AC: 7)
  - [ ] Configure linker parameter in GA4 tag
  - [ ] Add affiliate partner domains to linker
  - [ ] Create link decoration utility function
  - [ ] Update promocode click handlers to decorate URLs
  - [ ] Test cross-domain measurement with partners
  - [ ] Verify client ID persists across domains
- [ ] Integrate with existing analytics (AC: 1-8)
  - [ ] Update analytics abstraction layer for GA4
  - [ ] Ensure all PostHog events also fire to GA4
  - [ ] Maintain consistent event naming convention
  - [ ] Add GA4 to unified analytics wrapper
  - [ ] Test parallel tracking works correctly
  - [ ] Document event mapping between systems
- [ ] Write comprehensive tests (AC: 1-8)
  - [ ] Unit test GA4 initialization and consent
  - [ ] Test custom dimension mapping
  - [ ] Mock and test all GA4 events
  - [ ] Test scroll tracking triggers
  - [ ] Test cross-domain link decoration
  - [ ] E2E test complete user journey tracking

## Dev Notes
### Previous Story Insights
- Story 4.1 established GTM foundation with dataLayer initialization
- GTM container scripts are loaded in app layout
- Event abstraction pattern created in gtm-events.ts
- Custom dataLayer variables include traceId and cloakMode
- GTM Preview mode support already implemented

### GA4 Configuration in GTM
Based on [Source: architecture/observability-strategy.md]:
```javascript
// GTM Container - GA4 Configuration Tag
{
  tagName: "GA4 Configuration",
  type: "gaawc", // Google Analytics: GA4 Configuration
  parameter: [{
    key: "measurementId",
    value: "{{GA4_MEASUREMENT_ID}}" // GTM Variable
  }, {
    key: "sendPageView",
    value: "false" // Manual pageview control
  }, {
    key: "fieldsToSet",
    value: [{
      fieldName: "custom_map.dimension1",
      value: "trace_id"
    }, {
      fieldName: "custom_map.dimension2", 
      value: "cloak_mode"
    }, {
      fieldName: "custom_map.dimension3",
      value: "click_id"
    }, {
      fieldName: "custom_map.dimension4",
      value: "article_slug"
    }]
  }],
  trigger: [{
    type: "pageview" // All Pages trigger
  }]
}
```

### GA4 Initialization with Consent
Based on [Source: architecture/observability-strategy.md#client-side-initialization]:
```typescript
// src/lib/analytics/ga4.ts
'use client';

declare global {
  interface Window {
    gtag: (...args: any[]) => void;
  }
}

export function initGA4Consent() {
  if (typeof window !== 'undefined' && window.gtag) {
    // Default consent state (GDPR compliant)
    window.gtag('consent', 'default', {
      analytics_storage: 'denied',
      ad_storage: 'denied', 
      ad_user_data: 'denied',
      ad_personalization: 'denied',
      wait_for_update: 500
    });
  }
}

export function updateGA4Consent(consent: {
  analytics_storage: 'granted' | 'denied';
  ad_storage: 'granted' | 'denied';
}) {
  window.gtag('consent', 'update', consent);
}
```

### Enhanced Ecommerce Events
Based on [Source: architecture/observability-strategy.md#posthog-analytics-integration]:
```typescript
// src/lib/analytics/ga4-events.ts
export const ga4Events = {
  // Article view as item view
  viewItem: (article: {
    slug: string;
    title: string;
    category: string;
  }) => {
    window.dataLayer?.push({
      event: 'view_item',
      ecommerce: {
        currency: 'USD',
        value: 0, // Affiliate tracking, no direct value
        items: [{
          item_id: article.slug,
          item_name: article.title,
          item_category: 'article',
          item_category2: article.category,
          affiliation: 'content'
        }]
      },
      trace_id: window.__TRACE_ID__
    });
  },

  // Promocode display tracking
  viewPromotion: (promo: {
    code: string;
    position: string;
    widgetType: string;
  }) => {
    window.dataLayer?.push({
      event: 'view_promotion',
      ecommerce: {
        items: [{
          promotion_id: promo.code,
          promotion_name: promo.code,
          creative_name: promo.widgetType,
          creative_slot: promo.position
        }]
      }
    });
  },

  // Promocode interaction
  selectPromotion: (promo: {
    code: string;
    action: 'copied' | 'clicked';
  }) => {
    window.dataLayer?.push({
      event: 'select_promotion',
      ecommerce: {
        items: [{
          promotion_id: promo.code,
          promotion_name: promo.code
        }]
      },
      promocode_action: promo.action
    });
  }
};
```

### Scroll Tracking Configuration
```javascript
// GTM Scroll Depth Trigger
{
  name: "Scroll Depth Trigger",
  type: "scrollDepth",
  parameter: [{
    key: "verticalThresholds",
    value: "25,50,75,100"
  }],
  filter: [{
    type: "equals",
    parameter: [{
      key: "arg0",
      value: "{{Page Path}}"
    }, {
      key: "arg1", 
      value: "/article/*"
    }]
  }]
}
```

### Cross-Domain Tracking
Based on affiliate requirements:
```typescript
// src/lib/analytics/cross-domain.ts
export function decorateAffiliateLink(url: string): Promise<string> {
  return new Promise((resolve) => {
    if (window.gtag) {
      window.gtag('get', process.env.NEXT_PUBLIC_GA4_MEASUREMENT_ID!, 
        'linker', (linker: any) => {
          resolve(linker.decorate(url));
        }
      );
    } else {
      resolve(url);
    }
  });
}

// Usage in promocode click handler
async function handlePromocodeClick(targetUrl: string) {
  const decoratedUrl = await decorateAffiliateLink(targetUrl);
  window.open(decoratedUrl, '_blank');
}
```

### Conversion Event Setup
```typescript
// Define conversion events
export const conversionEvents = {
  promocodeCopied: (code: string) => {
    window.dataLayer?.push({
      event: 'conversion',
      event_category: 'engagement',
      event_label: 'promocode_copied',
      value: 1,
      promocode: code,
      send_to: process.env.NEXT_PUBLIC_GA4_MEASUREMENT_ID
    });
  },

  promocodeClicked: (code: string, targetUrl: string) => {
    window.dataLayer?.push({
      event: 'conversion',
      event_category: 'engagement', 
      event_label: 'promocode_clicked',
      value: 5, // Higher value for clicks
      promocode: code,
      target_url: targetUrl,
      send_to: process.env.NEXT_PUBLIC_GA4_MEASUREMENT_ID
    });
  }
};
```

### Audience Configuration
Based on cloak modes and user behavior:
```javascript
// GTM Custom JavaScript Variable for User Type
function() {
  var cloakMode = document.body.classList.contains('is-black-mode') ? 
    'black' : 'white';
  var hasInteracted = sessionStorage.getItem('promocode_interacted') === 'true';
  
  if (cloakMode === 'black' && hasInteracted) {
    return 'high_intent';
  } else if (cloakMode === 'black') {
    return 'trusted_visitor';
  } else {
    return 'standard_visitor';
  }
}
```

### Integration with Existing Analytics
Based on [Source: architecture/observability-strategy.md#posthog-analytics-integration]:
```typescript
// Update unified analytics wrapper
import { posthog } from './posthog';
import { ga4Events } from './ga4-events';

export const analytics = {
  pageView: (properties: PageViewProperties) => {
    // PostHog tracking
    posthog?.capture('$pageview', properties);
    
    // GA4 tracking via dataLayer
    window.dataLayer?.push({
      event: 'page_view',
      page_title: properties.title,
      page_location: properties.url,
      page_path: properties.path,
      trace_id: properties.traceId,
      cloak_mode: properties.cloakMode
    });
  },

  promocodeInteraction: (properties: PromocodeInteractionProperties) => {
    // PostHog tracking
    posthog?.capture('promocode_interaction', properties);
    
    // GA4 Enhanced Ecommerce
    if (properties.action === 'viewed') {
      ga4Events.viewPromotion(properties);
    } else if (properties.action === 'copied' || properties.action === 'clicked') {
      ga4Events.selectPromotion(properties);
      
      // Also track as conversion
      if (properties.action === 'copied') {
        conversionEvents.promocodeCopied(properties.code);
      } else {
        conversionEvents.promocodeClicked(properties.code, properties.targetUrl);
      }
    }
  }
};
```

### Environment Variables
Based on [Source: architecture/environment-configuration.md]:
```env
# Google Analytics 4
NEXT_PUBLIC_GA4_MEASUREMENT_ID=G-XXXXXXXXXX
```

### File Locations
Based on [Source: architecture/source-tree.md]:
```
src/
├── lib/
│   └── analytics/
│       ├── ga4.ts
│       ├── ga4-events.ts
│       ├── cross-domain.ts
│       └── consent.ts
```

### Testing
#### Test File Locations
- GA4 tests: `src/lib/analytics/__tests__/ga4.test.ts`
- Event tests: `src/lib/analytics/__tests__/ga4-events.test.ts`
- E2E tests: `e2e/ga4-tracking.spec.ts`

#### Testing Standards
Based on [Source: architecture/testing-strategy.md]:
- Mock window.gtag function in tests
- Test consent mode updates
- Verify custom dimensions are sent
- Test Enhanced Ecommerce event structure
- E2E test complete conversion funnel

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-07 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record
### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_