# Story 3.5: Click Tracking and Redirection

## Status
Draft

## Story
**As a** marketing analyst,
**I want** all promocode interactions tracked,
**so that** we can optimize conversion rates.

## Acceptance Criteria
1. Track widget impressions when scrolled into view
2. Track "Click to Reveal" interactions
3. Track successful code copies with timestamp
4. Track "Go to Site" CTA clicks
5. Send all events to TDS API for attribution
6. Include session and user IDs in tracking
7. Implement redirect through TDS for final attribution
8. Ensure tracking doesn't slow down user interactions

## Tasks / Subtasks
- [ ] Implement impression tracking (AC: 1, 8)
  - [ ] Create useImpressionTracking hook
  - [ ] Use IntersectionObserver API
  - [ ] Track when widget is 50% visible
  - [ ] Debounce tracking to prevent duplicates
  - [ ] Fire promocodeInteraction event with 'viewed' action
  - [ ] Include widget position and variant data
- [ ] Track reveal interactions (AC: 2, 6)
  - [ ] Update PromoCodeWidget reveal handler
  - [ ] Fire analytics event on click-to-reveal
  - [ ] Include timestamp and trace ID
  - [ ] Track time between impression and reveal
  - [ ] Include session context from PostHog
  - [ ] Test event firing reliability
- [ ] Enhance copy tracking (AC: 3, 6)
  - [ ] Update existing copy tracking from story 3.3
  - [ ] Add timestamp to copy events
  - [ ] Include session duration context
  - [ ] Track copy success rate
  - [ ] Monitor copy-to-conversion funnel
  - [ ] Ensure no duplicate events
- [ ] Create CTA redirection component (AC: 4, 7)
  - [ ] Add "Go to Site" button to PromoCodeWidget
  - [ ] Create server action for redirect handling
  - [ ] Call TDS API for redirect URL
  - [ ] Track click event before redirect
  - [ ] Handle redirect URL generation
  - [ ] Implement smooth transition UX
- [ ] Integrate TDS API for attribution (AC: 5, 7)
  - [ ] Create redirect service in tracker API
  - [ ] Pass promocode and click data to TDS
  - [ ] Get personalized redirect URL
  - [ ] Include all tracking parameters
  - [ ] Handle API errors with fallback URL
  - [ ] Log redirect events server-side
- [ ] Implement session tracking (AC: 6)
  - [ ] Extract click IDs from URL (yclid, gclid)
  - [ ] Get trace ID from window.__TRACE_ID__
  - [ ] Include PostHog session ID
  - [ ] Pass user context if available
  - [ ] Maintain session across interactions
  - [ ] Test ID persistence
- [ ] Optimize tracking performance (AC: 8)
  - [ ] Use requestIdleCallback for non-critical events
  - [ ] Batch analytics events when possible
  - [ ] Implement event queue with flush
  - [ ] Monitor tracking impact on performance
  - [ ] Add performance metrics logging
  - [ ] Test on slow connections
- [ ] Create comprehensive analytics dashboard (AC: 1-4)
  - [ ] Document all tracked events
  - [ ] Create funnel visualization spec
  - [ ] Define conversion metrics
  - [ ] Set up alerting thresholds
  - [ ] Document PostHog dashboard setup
  - [ ] Create A/B test analysis views
- [ ] Write comprehensive tests (AC: 1-8)
  - [ ] Unit test tracking hooks
  - [ ] Mock IntersectionObserver
  - [ ] Test analytics event firing
  - [ ] Test TDS API integration
  - [ ] Verify no performance regression
  - [ ] E2E test full tracking flow

## Dev Notes
### Previous Story Insights
- Story 3.3 implemented basic copy tracking
- Analytics integration already exists
- TDS API used for cloaking decisions
- PostHog configured for event tracking

### Impression Tracking Hook
Based on [Source: architecture/react-19-features.md]:
```typescript
// useImpressionTracking.ts
import { useEffect, useRef } from 'react';
import { analytics } from '@/lib/analytics';

export function useImpressionTracking(
  code: string,
  position: string
) {
  const hasTracked = useRef(false);
  const elementRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting && 
              entry.intersectionRatio >= 0.5 && 
              !hasTracked.current) {
            hasTracked.current = true;
            analytics.promocodeInteraction({
              action: 'viewed',
              code,
              articleSlug: window.location.pathname,
              position,
              traceId: window.__TRACE_ID__
            });
          }
        });
      },
      { threshold: 0.5 }
    );

    if (elementRef.current) {
      observer.observe(elementRef.current);
    }

    return () => observer.disconnect();
  }, [code, position]);

  return elementRef;
}
```

### Analytics Event Patterns
Based on [Source: architecture/observability-strategy.md#posthog-analytics-integration]:
```typescript
// Complete tracking implementation
analytics.promocodeInteraction({
  action: 'viewed' | 'revealed' | 'copied' | 'clicked',
  code: string,
  articleSlug: string,
  position?: string, // 'inline' | 'card' | 'banner'
  timestamp: new Date().toISOString(),
  sessionDuration: getSessionDuration(),
  traceId: window.__TRACE_ID__
});

// Conversion tracking
analytics.conversionEvent({
  type: 'click',
  promocode: code,
  articleSlug: articleSlug,
  redirectUrl: targetUrl,
  traceId: window.__TRACE_ID__
});
```

### Server Action for Redirection
Based on [Source: architecture/api-integration.md#usage-in-server-actions]:
```typescript
'use server';

import { redirect } from 'next/navigation';
import { trackerApiService } from '@/lib/services/tracker';
import { analytics } from '@/lib/analytics/server';

export async function handlePromocodeRedirect(
  code: string,
  targetUrl: string,
  clickId?: string
) {
  // Track server-side event
  await analytics.track({
    event: 'promocode_redirect',
    properties: {
      code,
      targetUrl,
      clickId,
      timestamp: new Date().toISOString()
    }
  });

  // Get redirect URL from TDS
  try {
    const { redirectUrl } = await trackerApiService.getRedirectUrl({
      promocode: code,
      target: targetUrl,
      clickId
    });
    
    redirect(redirectUrl);
  } catch (error) {
    // Fallback to direct URL
    redirect(targetUrl);
  }
}
```

### TDS API Integration
Based on [Source: architecture/api-integration.md#service-implementation-pattern]:
```typescript
// Extend tracker service for redirects
export const getRedirectUrl = async (params: {
  promocode: string;
  target: string;
  clickId?: string;
}) => {
  return httpClient.post(
    '/api/redirect',
    RedirectResponseSchema,
    {
      body: params,
      cache: 'no-store' // Never cache redirect URLs
    }
  );
};
```

### Performance Optimization
```typescript
// Event batching for performance
class AnalyticsQueue {
  private queue: AnalyticsEvent[] = [];
  private flushTimeout?: NodeJS.Timeout;

  add(event: AnalyticsEvent) {
    this.queue.push(event);
    this.scheduleFlush();
  }

  private scheduleFlush() {
    if (this.flushTimeout) return;
    
    this.flushTimeout = setTimeout(() => {
      requestIdleCallback(() => {
        this.flush();
      });
    }, 1000);
  }

  private flush() {
    if (this.queue.length === 0) return;
    
    analytics.batch(this.queue);
    this.queue = [];
    this.flushTimeout = undefined;
  }
}
```

### CTA Button Component
```typescript
// Inside PromoCodeWidget
{optimisticCopied && (
  <form action={handlePromocodeRedirect}>
    <input type="hidden" name="code" value={code} />
    <input type="hidden" name="targetUrl" value={targetUrl} />
    <button
      type="submit"
      className="mt-4 w-full bg-primary text-white py-3 rounded-lg
                 hover:bg-primary/90 transition-colors duration-200"
    >
      Go to Site →
    </button>
  </form>
)}
```

### Session Context
Based on [Source: architecture/observability-strategy.md#trace-id-architecture]:
```typescript
// Extract tracking IDs
const getTrackingContext = () => ({
  traceId: window.__TRACE_ID__,
  clickId: new URLSearchParams(window.location.search).get('yclid') || 
           new URLSearchParams(window.location.search).get('gclid'),
  sessionId: posthog.get_session_id(),
  userId: posthog.get_distinct_id()
});
```

### File Locations
Based on [Source: architecture/source-tree.md]:
```
src/
├── hooks/
│   └── useImpressionTracking.ts
├── lib/
│   ├── analytics/
│   │   └── queue.ts
│   └── services/
│       └── tracker/
│           └── tracker.api.ts (extend)
├── components/
│   └── widgets/
│       └── PromoCodeWidget.tsx (update)
```

### Testing
#### Test File Locations
- Hook tests: `src/hooks/__tests__/`
- Analytics tests: `src/lib/analytics/__tests__/`
- E2E tests: `e2e/tracking-flow.spec.ts`

#### Testing Standards
Based on [Source: architecture/testing-strategy.md]:
- Mock IntersectionObserver globally
- Test event debouncing logic
- Verify TDS API calls
- Test performance impact
- Check redirect flows

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-07 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record
### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_