# Story 4.1: Google Tag Manager Implementation

## Status
Draft

## Story
**As a** marketing analyst,
**I want** GTM installed as our tag management system,
**so that** we can manage all tracking pixels without code changes.

## Acceptance Criteria
1. Add GTM container snippet to app layout (head and body)
2. Configure GTM container ID via environment variable
3. Implement dataLayer initialization with page metadata
4. Create custom GTM events for promocode interactions
5. Set up Preview mode for testing GTM changes
6. Document all custom dataLayer variables
7. Ensure GTM loads asynchronously without blocking
8. Verify GTM works with Content Security Policy

## Tasks / Subtasks
- [ ] Create GTM component and integration (AC: 1, 2, 7)
  - [ ] Create src/lib/analytics/gtm.ts for GTM utilities
  - [ ] Create src/components/analytics/GoogleTagManager.tsx
  - [ ] Add GTM container scripts (head and body portions)
  - [ ] Configure container ID from NEXT_PUBLIC_GTM_ID env variable
  - [ ] Ensure scripts load with async/defer attributes
  - [ ] Test component renders both snippets correctly
- [ ] Integrate GTM into app layout (AC: 1)
  - [ ] Import GoogleTagManager component in app/layout.tsx
  - [ ] Place head snippet before closing </head>
  - [ ] Place body snippet immediately after <body>
  - [ ] Ensure snippets only render when GTM_ID is set
  - [ ] Test GTM loads on all pages
  - [ ] Verify no blocking of page render
- [ ] Implement dataLayer initialization (AC: 3)
  - [ ] Create global dataLayer array if not exists
  - [ ] Push initial page metadata on mount
  - [ ] Include page title, path, user type (cloak mode)
  - [ ] Add trace ID for correlation with other analytics
  - [ ] Initialize before GTM script loads
  - [ ] Test dataLayer contains expected values
- [ ] Create GTM event abstraction layer (AC: 4)
  - [ ] Create src/lib/analytics/gtm-events.ts
  - [ ] Define TypeScript types for all GTM events
  - [ ] Create push functions for each event type
  - [ ] Map existing promocode events to GTM format
  - [ ] Include event naming convention documentation
  - [ ] Test event structure matches GTM requirements
- [ ] Integrate promocode tracking with GTM (AC: 4)
  - [ ] Update promocode interaction handlers
  - [ ] Push events: promocode_viewed, promocode_copied, promocode_clicked
  - [ ] Include promocode details (code, position, widget type)
  - [ ] Add article context (slug, title)
  - [ ] Maintain existing PostHog tracking alongside
  - [ ] Test all promocode interactions fire GTM events
- [ ] Configure GTM Preview mode support (AC: 5)
  - [ ] Add GTM Preview query parameter detection
  - [ ] Support gtm_auth and gtm_preview parameters
  - [ ] Pass parameters to GTM initialization
  - [ ] Create debug mode for local development
  - [ ] Document Preview mode setup process
  - [ ] Test Preview mode works correctly
- [ ] Update Content Security Policy (AC: 8)
  - [ ] Add www.googletagmanager.com to script-src
  - [ ] Add www.google-analytics.com to connect-src
  - [ ] Add tagmanager.google.com for Preview mode
  - [ ] Ensure nonce support for inline scripts
  - [ ] Test GTM loads without CSP violations
  - [ ] Document CSP requirements
- [ ] Create comprehensive documentation (AC: 6)
  - [ ] Document all custom dataLayer variables
  - [ ] List all custom events with properties
  - [ ] Create GTM configuration guide
  - [ ] Document testing procedures
  - [ ] Add troubleshooting section
  - [ ] Include example GTM tag configurations
- [ ] Write comprehensive tests (AC: 1-8)
  - [ ] Unit test GTM component rendering
  - [ ] Test environment variable configuration
  - [ ] Test dataLayer initialization
  - [ ] Mock and test all GTM events
  - [ ] Test Preview mode parameters
  - [ ] E2E test GTM loads and receives events
  - [ ] Test CSP compliance

## Dev Notes
### Previous Story Insights
- Analytics architecture from Epic 3 established event patterns with PostHog
- Trace ID system (window.__TRACE_ID__) must be included in all GTM events
- Cloak mode state affects which events should fire (some events only in black mode)
- Existing promocode tracking must continue working alongside GTM

### GTM Component Structure
Based on [Source: architecture/component-standards.md]:
```typescript
// src/components/analytics/GoogleTagManager.tsx
'use client';

interface GoogleTagManagerProps {
  gtmId: string;
  gtmAuth?: string;
  gtmPreview?: string;
  nonce?: string;
}

export function GoogleTagManager({ 
  gtmId, 
  gtmAuth, 
  gtmPreview,
  nonce 
}: GoogleTagManagerProps) {
  // Implementation follows Next.js Script component pattern
}
```

### Environment Configuration
Based on [Source: architecture/environment-configuration.md]:
```env
# Google Tag Manager
NEXT_PUBLIC_GTM_ID=GTM-XXXXXXX
NEXT_PUBLIC_GTM_AUTH=your-auth-string # Optional: for environment-specific containers
NEXT_PUBLIC_GTM_PREVIEW=env-XX # Optional: for preview mode
```

### DataLayer Initialization Pattern
Based on [Source: architecture/observability-strategy.md#client-side-initialization]:
```typescript
// Initialize dataLayer before GTM loads
declare global {
  interface Window {
    dataLayer: any[];
    __TRACE_ID__: string;
  }
}

window.dataLayer = window.dataLayer || [];
window.dataLayer.push({
  'gtm.start': new Date().getTime(),
  event: 'gtm.js',
  pageType: 'article',
  cloakMode: getCloakMode(),
  traceId: window.__TRACE_ID__
});
```

### GTM Event Types
Based on [Source: architecture/observability-strategy.md#posthog-analytics-integration]:
```typescript
// src/lib/analytics/gtm-events.ts
export interface GTMEvent {
  event: string;
  eventCategory?: string;
  eventAction?: string;
  eventLabel?: string;
  eventValue?: number;
  [key: string]: any;
}

export const gtmEvents = {
  pageView: (data: PageViewData): GTMEvent => ({
    event: 'page_view',
    pageTitle: data.title,
    pagePath: data.path,
    cloakMode: data.cloakMode,
    traceId: data.traceId
  }),
  
  promocodeInteraction: (data: PromocodeInteractionData): GTMEvent => ({
    event: 'promocode_interaction',
    eventCategory: 'engagement',
    eventAction: data.action, // 'viewed' | 'copied' | 'clicked'
    eventLabel: data.code,
    promocodeDetails: {
      code: data.code,
      position: data.position,
      widgetType: data.widgetType,
      articleSlug: data.articleSlug
    },
    traceId: data.traceId
  })
};
```

### Integration with Existing Analytics
Based on [Source: architecture/observability-strategy.md#core-components]:
```typescript
// Wrap existing analytics calls to include GTM
export function trackPromocodeInteraction(data: PromocodeInteractionData) {
  // Existing PostHog tracking
  posthog.capture('promocode_interaction', data);
  
  // Add GTM tracking
  window.dataLayer?.push(gtmEvents.promocodeInteraction(data));
}
```

### Content Security Policy Updates
Based on security requirements:
```typescript
// In middleware or security headers
const cspHeader = `
  script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://tagmanager.google.com;
  connect-src 'self' https://www.google-analytics.com https://www.googletagmanager.com;
  img-src 'self' https://www.googletagmanager.com https://www.google-analytics.com;
`;
```

### Testing Approach
Based on [Source: architecture/testing-strategy.md]:
```typescript
// Mock GTM in tests
vi.mock('@/lib/analytics/gtm', () => ({
  pushToDataLayer: vi.fn(),
  gtmEvents: {
    pageView: vi.fn(),
    promocodeInteraction: vi.fn()
  }
}));

// Test GTM events are pushed correctly
expect(window.dataLayer).toContainEqual(
  expect.objectContaining({
    event: 'promocode_interaction',
    eventAction: 'copied'
  })
);
```

### File Locations
Based on [Source: architecture/source-tree.md]:
```
src/
├── components/
│   └── analytics/
│       └── GoogleTagManager.tsx
├── lib/
│   └── analytics/
│       ├── gtm.ts
│       └── gtm-events.ts
├── app/
│   └── layout.tsx (integration point)
```

### Testing
#### Test File Locations
- Component tests: `src/components/analytics/__tests__/GoogleTagManager.test.tsx`
- Event tests: `src/lib/analytics/__tests__/gtm-events.test.ts`
- E2E tests: `e2e/gtm-tracking.spec.ts`

#### Testing Standards
Based on [Source: architecture/testing-strategy.md]:
- Mock window.dataLayer in unit tests
- Test all event shapes match GTM requirements
- Verify CSP compliance
- Test Preview mode parameters
- E2E verify GTM loads and receives events

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-07 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record
### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_